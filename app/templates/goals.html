{% extends "base.html" %}
{% block content %}

<div class="goals-page">
  <div class="page-header">
    <h1 class="h1">
      <i class="bi bi-trophy" aria-hidden="true"></i>
      Financial Goals
    </h1>
    <p class="subtitle">Set and track your financial objectives</p>
  </div>

  <!-- Action Buttons -->
  <div class="actions-bar">
    <button class="btn primary" onclick="showCreateGoalModal()" aria-label="Create new goal">
      <i class="bi bi-plus-circle"></i> New Goal
    </button>
    <button class="btn ghost" onclick="refreshGoals()" aria-label="Refresh goals list">
      <i class="bi bi-arrow-clockwise"></i> Refresh
    </button>
  </div>

  <!-- Statistics Overview -->
  <div id="stats-section" class="stats-grid">
    <!-- Will be populated dynamically -->
  </div>

  <!-- Filter Tabs -->
  <div class="filter-tabs" role="tablist">
    <button class="filter-tab active" onclick="filterGoals('all', event)" role="tab">All Goals</button>
    <button class="filter-tab" onclick="filterGoals('active', event)" role="tab">Active</button>
    <button class="filter-tab" onclick="filterGoals('completed', event)" role="tab">Completed</button>
  </div>

  <!-- Goals List -->
  <div id="goals-list" class="goals-grid">
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading goals...</p>
    </div>
  </div>

  <!-- Empty State -->
  <div id="empty-state" class="empty-state" style="display: none;">
    <i class="bi bi-trophy" style="font-size: 4rem; opacity: 0.3;"></i>
    <h3>No goals yet</h3>
    <p>Create your first financial goal to start tracking your progress</p>
    <button class="btn primary" onclick="showCreateGoalModal()">
      <i class="bi bi-plus-circle"></i> Create Your First Goal
    </button>
  </div>
</div>

<!-- Create/Edit Goal Modal -->
<div id="goal-modal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modal-title">Create New Goal</h2>
      <button class="btn-close" onclick="closeGoalModal()" aria-label="Close modal">&times;</button>
    </div>
    <form id="goal-form" onsubmit="handleGoalSubmit(event)">
      <div class="form-group">
        <label for="goal-name">Goal Name *</label>
        <input type="text" id="goal-name" name="name" required maxlength="255" class="input" placeholder="e.g., Emergency Fund">
      </div>

      <div class="form-group">
        <label for="goal-type">Goal Type *</label>
        <select id="goal-type" name="goal_type" required class="input" onchange="handleGoalTypeChange()">
          <option value="savings">Savings Goal</option>
          <option value="spending_limit">Spending Limit</option>
          <option value="debt_payoff">Debt Payoff</option>
          <option value="emergency_fund">Emergency Fund</option>
          <option value="custom">Custom Goal</option>
        </select>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="goal-target">Target Amount *</label>
          <input type="number" id="goal-target" name="target_amount" required min="0" step="0.01" class="input">
        </div>
        <div class="form-group">
          <label for="goal-current">Current Amount</label>
          <input type="number" id="goal-current" name="current_amount" min="0" step="0.01" class="input" value="0">
        </div>
      </div>

      <div class="form-group" id="category-group" style="display: none;">
        <label for="goal-category">Category</label>
        <select id="goal-category" name="category_id" class="input">
          <option value="">Select category...</option>
          <!-- Will be populated dynamically -->
        </select>
      </div>

      <div class="form-group">
        <label for="goal-target-date">Target Date (Optional)</label>
        <input type="date" id="goal-target-date" name="target_date" class="input">
      </div>

      <div class="form-group">
        <label for="goal-description">Description (Optional)</label>
        <textarea id="goal-description" name="description" rows="3" class="input" placeholder="Add notes about your goal..."></textarea>
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" id="goal-notify" name="notify_on_milestone" checked>
          Notify me on milestones
        </label>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn ghost" onclick="closeGoalModal()">Cancel</button>
        <button type="submit" class="btn primary">
          <span id="submit-text">Create Goal</span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Goal Detail Modal -->
<div id="goal-detail-modal" class="modal" style="display: none;">
  <div class="modal-content large">
    <div class="modal-header">
      <h2 id="detail-goal-name">Goal Details</h2>
      <button class="btn-close" onclick="closeDetailModal()" aria-label="Close">&times;</button>
    </div>
    <div id="goal-detail-content">
      <!-- Will be populated dynamically -->
    </div>
  </div>
</div>

<style>
/* Goals Page Styles */
.goals-page {
  max-width: 1400px;
  margin: 0 auto;
}

.page-header {
  margin-bottom: 2rem;
}

.page-header .h1 {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 0.5rem;
}

.subtitle {
  color: var(--text-muted);
  font-size: 1.125rem;
}

.actions-bar {
  display: flex;
  gap: 1rem;
  margin-bottom: 2rem;
}

/* Statistics Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.stat-card {
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1.5rem;
  text-align: center;
}

.stat-value {
  font-size: 2rem;
  font-weight: bold;
  color: var(--primary);
  margin: 0.5rem 0;
}

.stat-label {
  color: var(--text-muted);
  font-size: 0.875rem;
}

/* Filter Tabs */
.filter-tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
  border-bottom: 2px solid var(--border);
}

.filter-tab {
  padding: 0.75rem 1.5rem;
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-weight: 500;
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
  transition: all 0.2s;
}

.filter-tab:hover {
  color: var(--text);
}

.filter-tab.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
}

/* Goals Grid */
.goals-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 1.5rem;
}

.goal-card {
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1.5rem;
  transition: transform 0.2s, box-shadow 0.2s;
  cursor: pointer;
}

.goal-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.goal-header {
  display: flex;
  justify-content: space-between;
  align-items: start;
  margin-bottom: 1rem;
}

.goal-name {
  font-size: 1.25rem;
  font-weight: 600;
  margin: 0;
}

.goal-type-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 500;
  background: var(--primary-alpha);
  color: var(--primary);
}

.progress-section {
  margin: 1.5rem 0;
}

.progress-bar-container {
  background: var(--surface-3);
  border-radius: 10px;
  height: 20px;
  overflow: hidden;
  margin-bottom: 0.5rem;
}

.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--accent));
  transition: width 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding-right: 0.5rem;
}

.progress-text {
  font-size: 0.75rem;
  color: white;
  font-weight: 600;
}

.progress-amounts {
  display: flex;
  justify-content: space-between;
  font-size: 0.875rem;
  color: var(--text-muted);
}

.goal-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border);
  font-size: 0.875rem;
  color: var(--text-muted);
}

.goal-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 1rem;
}

.btn-small {
  padding: 0.5rem 1rem;
  font-size: 0.875rem;
}

/* Status Badges */
.status-active { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
.status-completed { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
.status-failed { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

/* Empty State */
.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  color: var(--text-muted);
}

/* Modal Styles */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 1rem;
}

.modal-content {
  background: var(--surface);
  border-radius: 16px;
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-content.large {
  max-width: 900px;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.5rem;
  border-bottom: 1px solid var(--border);
}

.modal-header h2 {
  margin: 0;
}

.btn-close {
  background: none;
  border: none;
  font-size: 2rem;
  cursor: pointer;
  color: var(--text-muted);
  line-height: 1;
  padding: 0;
  width: 2rem;
  height: 2rem;
}

.btn-close:hover {
  color: var(--text);
}

.modal form {
  padding: 1.5rem;
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.form-group label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
}

.form-group input[type="checkbox"] {
  margin-right: 0.5rem;
}

.modal-actions {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
  padding: 1.5rem;
  border-top: 1px solid var(--border);
  margin: 0 -1.5rem -1.5rem;
}

/* Loading State */
.loading-state {
  text-align: center;
  padding: 3rem;
  color: var(--text-muted);
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid var(--border);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 1rem;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Responsive */
@media (max-width: 768px) {
  .goals-grid {
    grid-template-columns: 1fr;
  }

  .form-row {
    grid-template-columns: 1fr;
  }
}

/* Light Theme */
[data-theme="light"] .goal-card {
  background: white;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .goal-card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}
</style>

<script>
// Global variables
const CURRENCY_SYMBOL = '{% if user_currency %}{{ user_currency.symbol }}{% else %}${% endif %}';
const CURRENCY_CODE = '{{ user_currency_code | default("USD") }}';
let currentFilter = 'all';
let currentGoalId = null;
let allGoals = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
  loadStatistics();
  loadGoals();
  loadCategories();
});

// Load statistics
async function loadStatistics() {
  try {
    const response = await fetch('/api/goals/statistics/overview');
    const data = await response.json();

    if (data.success) {
      displayStatistics(data.statistics);
    }
  } catch (error) {
    console.error('Error loading statistics:', error);
  }
}

function displayStatistics(stats) {
  const statsSection = document.getElementById('stats-section');
  statsSection.innerHTML = `
    <div class="stat-card">
      <div class="stat-label">Total Goals</div>
      <div class="stat-value">${stats.total_goals}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Active</div>
      <div class="stat-value" style="color: #22c55e;">${stats.active_goals}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Completed</div>
      <div class="stat-value" style="color: #3b82f6;">${stats.completed_goals}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Overall Progress</div>
      <div class="stat-value">${stats.overall_progress.toFixed(1)}%</div>
    </div>
  `;
}

// Load goals
async function loadGoals() {
  try {
    const response = await fetch('/api/goals/?include_completed=true');
    const data = await response.json();

    if (data.success) {
      allGoals = data.goals;
      filterGoals(currentFilter);
    }
  } catch (error) {
    console.error('Error loading goals:', error);
    document.getElementById('goals-list').innerHTML = '<div class="loading-state"><p>Error loading goals</p></div>';
  }
}

function filterGoals(filter, event = null) {
  currentFilter = filter;

  // Update active tab
  document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
  if (event && event.target) {
    event.target.classList.add('active');
  } else {
    // If no event (programmatic call), activate the correct tab
    const tabs = document.querySelectorAll('.filter-tab');
    if (filter === 'all' && tabs[0]) tabs[0].classList.add('active');
    if (filter === 'active' && tabs[1]) tabs[1].classList.add('active');
    if (filter === 'completed' && tabs[2]) tabs[2].classList.add('active');
  }

  // Filter goals
  let filteredGoals = allGoals;
  if (filter === 'active') {
    filteredGoals = allGoals.filter(g => g.status === 'active');
  } else if (filter === 'completed') {
    filteredGoals = allGoals.filter(g => g.status === 'completed');
  }

  displayGoals(filteredGoals);
}

function displayGoals(goals) {
  const goalsContainer = document.getElementById('goals-list');
  const emptyState = document.getElementById('empty-state');

  if (goals.length === 0) {
    goalsContainer.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }

  emptyState.style.display = 'none';
  goalsContainer.style.display = 'grid';

  goalsContainer.innerHTML = goals.map(goal => `
    <div class="goal-card" onclick="showGoalDetail(${goal.id})">
      <div class="goal-header">
        <h3 class="goal-name">${escapeHtml(goal.name)}</h3>
        <span class="goal-type-badge">${formatGoalType(goal.goal_type)}</span>
      </div>

      <div class="progress-section">
        <div class="progress-bar-container">
          <div class="progress-bar" style="width: ${Math.min(goal.progress_percentage, 100)}%">
            ${goal.progress_percentage > 10 ? `<span class="progress-text">${goal.progress_percentage.toFixed(0)}%</span>` : ''}
          </div>
        </div>
        <div class="progress-amounts">
          <span>${CURRENCY_SYMBOL}${formatAmount(goal.current_amount)}</span>
          <span>${CURRENCY_SYMBOL}${formatAmount(goal.target_amount)}</span>
        </div>
      </div>

      <div class="goal-meta">
        <span class="status-${goal.status}">
          <i class="bi bi-circle-fill"></i> ${formatStatus(goal.status)}
        </span>
        ${goal.target_date ? `<span><i class="bi bi-calendar"></i> ${formatDate(goal.target_date)}</span>` : ''}
      </div>
    </div>
  `).join('');
}

// Load categories for dropdown
async function loadCategories() {
  try {
    const response = await fetch('/categories/api/list');
    const data = await response.json();

    if (data.success) {
      const select = document.getElementById('goal-category');
      select.innerHTML = '<option value="">Select category...</option>' +
        data.categories.map(cat => `<option value="${cat.id}">${escapeHtml(cat.name)}</option>`).join('');
    }
  } catch (error) {
    console.error('Error loading categories:', error);
  }
}

// Modal functions
function showCreateGoalModal() {
  document.getElementById('modal-title').textContent = 'Create New Goal';
  document.getElementById('submit-text').textContent = 'Create Goal';
  document.getElementById('goal-form').reset();
  currentGoalId = null;
  document.getElementById('goal-modal').style.display = 'flex';
}

function closeGoalModal() {
  document.getElementById('goal-modal').style.display = 'none';
}

function handleGoalTypeChange() {
  const type = document.getElementById('goal-type').value;
  const categoryGroup = document.getElementById('category-group');
  categoryGroup.style.display = type === 'spending_limit' ? 'block' : 'none';
}

async function handleGoalSubmit(event) {
  event.preventDefault();

  const formData = new FormData(event.target);
  const data = {
    name: formData.get('name'),
    goal_type: formData.get('goal_type'),
    target_amount: parseFloat(formData.get('target_amount')),
    description: formData.get('description') || null,
    target_date: formData.get('target_date') || null,
    category_id: formData.get('category_id') ? parseInt(formData.get('category_id')) : null,
    notify_on_milestone: formData.get('notify_on_milestone') === 'on',
    currency_code: CURRENCY_CODE
  };

  try {
    const response = await fetch('/api/goals/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const result = await response.json();

    if (result.success) {
      closeGoalModal();
      loadGoals();
      loadStatistics();
      // Show success message
      if (typeof Toast !== 'undefined') {
        Toast.success('Goal created successfully!');
      }
    }
  } catch (error) {
    console.error('Error creating goal:', error);
    if (typeof Toast !== 'undefined') {
      Toast.error('Failed to create goal');
    }
  }
}

async function showGoalDetail(goalId) {
  try {
    const response = await fetch(`/api/goals/${goalId}`);
    const data = await response.json();

    if (data.success) {
      displayGoalDetail(data.goal);
    }
  } catch (error) {
    console.error('Error loading goal details:', error);
  }
}

function displayGoalDetail(goal) {
  document.getElementById('detail-goal-name').textContent = goal.name;

  const content = document.getElementById('goal-detail-content');
  content.innerHTML = `
    <div style="padding: 1.5rem;">
      <div class="progress-section">
        <h3>Progress</h3>
        <div class="progress-bar-container" style="height: 30px;">
          <div class="progress-bar" style="width: ${Math.min(goal.progress_percentage, 100)}%">
            <span class="progress-text">${goal.progress_percentage.toFixed(1)}%</span>
          </div>
        </div>
        <div class="progress-amounts" style="margin-top: 1rem; font-size: 1.125rem;">
          <span><strong>${CURRENCY_SYMBOL}${formatAmount(goal.current_amount)}</strong> of ${CURRENCY_SYMBOL}${formatAmount(goal.target_amount)}</span>
        </div>
      </div>

      ${goal.description ? `<div style="margin: 1.5rem 0;"><h4>Description</h4><p>${escapeHtml(goal.description)}</p></div>` : ''}

      <div class="goal-actions" style="margin-top: 2rem;">
        <button class="btn primary" onclick="updateProgress(${goal.id})">
          <i class="bi bi-plus-circle"></i> Update Progress
        </button>
        <button class="btn ghost" onclick="deleteGoal(${goal.id})">
          <i class="bi bi-trash"></i> Delete
        </button>
        <button class="btn ghost" onclick="closeDetailModal()">Close</button>
      </div>
    </div>
  `;

  document.getElementById('goal-detail-modal').style.display = 'flex';
}

function closeDetailModal() {
  document.getElementById('goal-detail-modal').style.display = 'none';
}

async function updateProgress(goalId) {
  const amount = prompt('Enter new progress amount:');
  if (!amount) return;

  try {
    const response = await fetch(`/api/goals/${goalId}/progress`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        current_amount: parseFloat(amount),
        note: 'Manual update'
      })
    });

    const result = await response.json();

    if (result.success) {
      closeDetailModal();
      loadGoals();
      loadStatistics();
      if (typeof Toast !== 'undefined') {
        Toast.success(result.goal.completed ? 'Goal completed! ðŸŽ‰' : 'Progress updated!');
      }
    }
  } catch (error) {
    console.error('Error updating progress:', error);
  }
}

async function deleteGoal(goalId) {
  if (!confirm('Are you sure you want to delete this goal?')) return;

  try {
    const response = await fetch(`/api/goals/${goalId}`, { method: 'DELETE' });
    const result = await response.json();

    if (result.success) {
      closeDetailModal();
      loadGoals();
      loadStatistics();
      if (typeof Toast !== 'undefined') {
        Toast.success('Goal deleted');
      }
    }
  } catch (error) {
    console.error('Error deleting goal:', error);
  }
}

function refreshGoals() {
  loadGoals();
  loadStatistics();
}

// Utility functions
function formatAmount(amount) {
  // Format number with commas, no currency symbol
  return Number(amount).toLocaleString('en-US', {
    minimumFractionDigits: 0,
    maximumFractionDigits: 2
  });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function formatGoalType(type) {
  const types = {
    'savings': 'Savings',
    'spending_limit': 'Spending Limit',
    'debt_payoff': 'Debt Payoff',
    'emergency_fund': 'Emergency Fund',
    'custom': 'Custom'
  };
  return types[type] || type;
}

function formatStatus(status) {
  const statuses = {
    'active': 'Active',
    'completed': 'Completed',
    'cancelled': 'Cancelled',
    'failed': 'Failed'
  };
  return statuses[status] || status;
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString();
}
</script>

{% endblock %}
