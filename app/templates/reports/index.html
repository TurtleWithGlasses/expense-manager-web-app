{% extends "base.html" %}
{% block content %}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2" style="color: var(--text);">
                    <i class="bi bi-graph-up-arrow me-2"></i>
                    Financial Reports
                </h1>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="showCustomReportModal()">
                        <i class="bi bi-calendar-range me-1"></i>
                        Custom Report
                    </button>
                    <a href="/reports/settings" class="btn btn-outline-secondary">
                        <i class="bi bi-gear me-1"></i>
                        Settings
                    </a>
                </div>
            </div>
            
            <!-- Report Type Cards -->
            <div class="row g-4 mb-5">
                <!-- Weekly Reports -->
                <div class="col-12">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0 text-white">
                                    <i class="bi bi-calendar-week me-2"></i>
                                    Weekly Reports
                                </h5>
                                <span class="badge bg-light text-dark">Focus on Expenses</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <p class="card-text text-light">
                                        Detailed analysis of your weekly spending patterns, expense trends, and budget control achievements.
                                    </p>
                                    <ul class="list-unstyled text-light">
                                        <li><i class="bi bi-check-circle text-success me-2"></i>Expense tracking & trends</li>
                                        <li><i class="bi bi-check-circle text-success me-2"></i>Category analysis</li>
                                        <li><i class="bi bi-check-circle text-success me-2"></i>Spending achievements</li>
                                        <li><i class="bi bi-check-circle text-success me-2"></i>Budget recommendations</li>
                                    </ul>
                                </div>
                                <div class="col-md-4 d-flex align-items-center">
                                    <div class="d-grid gap-2 w-100">
                                        <a href="/reports/weekly" class="btn btn-primary">
                                            <i class="bi bi-file-text me-1"></i>
                                            View Weekly Reports
                                        </a>
                                        <button class="btn btn-outline-primary btn-sm" onclick="emailWeeklyReport()">
                                            <i class="bi bi-envelope me-1"></i>
                                            Email Current Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Monthly Reports -->
                <div class="col-12">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-success text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0 text-white">
                                    <i class="bi bi-calendar-month me-2"></i>
                                    Monthly Reports
                                </h5>
                                <span class="badge bg-light text-dark">Full Financial Picture</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <p class="card-text text-light">
                                        Comprehensive monthly financial analysis including income, expenses, savings rate, and financial health.
                                    </p>
                                    <ul class="list-unstyled text-light">
                                        <li><i class="bi bi-check-circle text-success me-2"></i>Income vs expenses</li>
                                        <li><i class="bi bi-check-circle text-success me-2"></i>Savings rate analysis</li>
                                        <li><i class="bi bi-check-circle text-success me-2"></i>Monthly trends</li>
                                        <li><i class="bi bi-check-circle text-success me-2"></i>Financial goals</li>
                                    </ul>
                                </div>
                                <div class="col-md-4 d-flex align-items-center">
                                    <div class="d-grid gap-2 w-100">
                                        <a href="/reports/monthly" class="btn btn-primary">
                                            <i class="bi bi-file-text me-1"></i>
                                            View Monthly Reports
                                        </a>
                                        <button class="btn btn-outline-primary btn-sm" onclick="emailMonthlyReport()">
                                            <i class="bi bi-envelope me-1"></i>
                                            Email Current Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Annual Reports -->
                <div class="col-12">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-warning text-dark">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0 text-dark">
                                    <i class="bi bi-calendar-year me-2"></i>
                                    Annual Reports
                                </h5>
                                <span class="badge bg-light text-dark">Long-term Analysis</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <p class="card-text text-light">
                                        Year-long financial analysis with comprehensive insights, trends, and recommendations for financial growth.
                                    </p>
                                    <ul class="list-unstyled text-light">
                                        <li><i class="bi bi-check-circle text-success me-2"></i>Annual spending patterns</li>
                                        <li><i class="bi bi-check-circle text-success me-2"></i>Income growth trends</li>
                                        <li><i class="bi bi-check-circle text-success me-2"></i>Financial milestones</li>
                                        <li><i class="bi bi-check-circle text-success me-2"></i>Investment recommendations</li>
                                    </ul>
                                </div>
                                <div class="col-md-4 d-flex align-items-center">
                                    <div class="d-grid gap-2 w-100">
                                        <a href="/reports/annual" class="btn btn-primary">
                                            <i class="bi bi-file-text me-1"></i>
                                            View Annual Reports
                                        </a>
                                        <button class="btn btn-outline-primary btn-sm" onclick="emailAnnualReport()">
                                            <i class="bi bi-envelope me-1"></i>
                                            Email Current Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Reports -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0" style="color: var(--text);">
                                <i class="bi bi-clock-history me-2"></i>
                                Recent Reports
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover table-striped">
                                    <thead class="table-dark">
                                        <tr>
                                            <th class="text-white fw-bold">Report Type</th>
                                            <th class="text-white fw-bold">Period</th>
                                            <th class="text-white fw-bold">Last Updated</th>
                                            <th class="text-white fw-bold">Status</th>
                                            <th class="text-white fw-bold">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-reports-tbody">
                                        <!-- Dynamic content will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Report Modal -->
<div class="modal fade" id="customReportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-calendar-range me-2"></i>
                    Generate Custom Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="customReportForm">
                    <div class="mb-3">
                        <label for="reportType" class="form-label">Report Type</label>
                        <select class="form-select" id="reportType" name="reportType" required>
                            <option value="expense">Expense Analysis</option>
                            <option value="income">Income Analysis</option>
                            <option value="comprehensive">Comprehensive</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate" name="startDate" required>
                        </div>
                        <div class="col-md-6">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="endDate" name="endDate" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="generateCustomReport()">
                    <i class="bi bi-file-text me-1"></i>
                    Generate Report
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function showCustomReportModal() {
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('customReportModal'));
    modal.show();
}

function generateCustomReport() {
    // Get form data
    const form = document.getElementById('customReportForm');
    const formData = new FormData(form);

    const reportType = formData.get('reportType');
    const startDate = formData.get('startDate');
    const endDate = formData.get('endDate');

    // Validate dates
    if (!startDate || !endDate) {
        Toast.warning('Please select both start and end dates', 'Invalid Date Range');
        return;
    }

    if (new Date(startDate) > new Date(endDate)) {
        Toast.error('Start date must be before end date', 'Invalid Date Range');
        return;
    }

    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('customReportModal'));
    modal.hide();

    // Show success message
    Toast.success('Generating your custom report...', 'Report Generation');

    // Build export URL based on report type
    let exportUrl;
    if (reportType === 'expense') {
        exportUrl = `/reports/excel/entries?start=${startDate}&end=${endDate}&report_type=expense`;
    } else if (reportType === 'income') {
        exportUrl = `/reports/excel/entries?start=${startDate}&end=${endDate}&report_type=income`;
    } else {
        // Comprehensive report - use PDF export
        exportUrl = `/reports/pdf/financial?start=${startDate}&end=${endDate}&report_type=all`;
    }

    // Trigger download
    window.location.href = exportUrl;
}

function emailWeeklyReport() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Sending...';
    button.disabled = true;
    
    fetch('/reports/weekly/email', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ Weekly report email sent successfully!');
            } else {
                alert('❌ Failed to send email: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Error sending email. Please try again.');
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
}

function emailMonthlyReport() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Sending...';
    button.disabled = true;
    
    fetch('/reports/monthly/email', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ Monthly report email sent successfully!');
            } else {
                alert('❌ Failed to send email: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Error sending email. Please try again.');
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
}

function emailAnnualReport() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Sending...';
    button.disabled = true;
    
    fetch('/reports/annual/email', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ Annual report email sent successfully!');
            } else {
                alert('❌ Failed to send email: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Error sending email. Please try again.');
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
}

function viewReport(type, period) {
    // Mark report as viewed before navigating
    markReportAsViewed(type, period);
    
    if (period === 'current') {
        // Navigate to the main report page for current period
        window.location.href = `/reports/${type}`;
    } else {
        // For now, all reports are current - redirect to main report page
        // TODO: Implement historical report storage and retrieval
        console.warn(`Historical report ${type}/${period} not yet implemented. Redirecting to current ${type} report.`);
        window.location.href = `/reports/${type}`;
    }
}

function markReportAsViewed(type, period) {
    fetch('/reports/status/mark-viewed', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            report_type: type,
            report_period: period
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the report statuses to update the UI
            loadReportStatuses();
        }
    })
    .catch(error => {
        console.error('Error marking report as viewed:', error);
    });
}

function loadReportStatuses() {
    fetch('/reports/status/')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('recent-reports-tbody');
            if (tbody && data.statuses) {
                tbody.innerHTML = generateReportRows(data.statuses);
            }
        })
        .catch(error => {
            console.error('Error loading report statuses:', error);
        });
}

function generateReportRows(statuses) {
    const reports = [
        { type: 'weekly', label: 'Weekly', badgeClass: 'bg-primary', period: 'Current Week' },
        { type: 'monthly', label: 'Monthly', badgeClass: 'bg-success', period: 'Current Month' },
        { type: 'annual', label: 'Annual', badgeClass: 'bg-warning text-dark', period: 'Current Year' }
    ];
    
    return reports.map(report => {
        const status = statuses[report.type] || { is_new: true, last_viewed: null };
        const statusBadge = status.is_new ? 
            '<span class="badge bg-success">New</span>' : 
            '<span class="badge bg-secondary">Viewed</span>';
        
        const lastUpdated = status.last_updated ? 
            formatRelativeTime(status.last_updated) : 
            'Just now';
        
        return `
            <tr>
                <td class="text-dark">
                    <span class="badge ${report.badgeClass}">${report.label}</span>
                </td>
                <td class="text-dark">${report.period}</td>
                <td class="text-dark">${lastUpdated}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewReport('${report.type}', 'current')">
                        <i class="bi bi-eye me-1"></i>View
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="emailReport('${report.type}', 'current')">
                        <i class="bi bi-envelope me-1"></i>Email
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function formatRelativeTime(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString();
}

// Load report statuses when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadReportStatuses();
});

function emailReport(type, period) {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Sending...';
    button.disabled = true;
    
    fetch(`/reports/${type}/email`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`✅ ${type.charAt(0).toUpperCase() + type.slice(1)} report email sent successfully!`);
            } else {
                alert(`❌ Failed to send ${type} email: ` + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(`❌ Error sending ${type} email. Please try again.`);
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
}
</script>

{% endblock %}
