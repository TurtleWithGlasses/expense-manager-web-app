{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">User Details</h1>
            <p class="text-muted">{{ target_user.email }}</p>
        </div>
        <a href="/admin/users" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Users
        </a>
    </div>

    <div class="row g-4">
        <!-- User Information -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Account Information</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">User ID</dt>
                        <dd class="col-sm-8">{{ target_user.id }}</dd>

                        <dt class="col-sm-4">Email</dt>
                        <dd class="col-sm-8">
                            {{ target_user.email }}
                            {% if target_user.is_admin %}
                            <span class="badge bg-danger ms-1">Admin</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-4">Full Name</dt>
                        <dd class="col-sm-8">{{ target_user.full_name or '-' }}</dd>

                        <dt class="col-sm-4">Status</dt>
                        <dd class="col-sm-8">
                            {% if target_user.is_verified %}
                            <span class="badge bg-success">Verified</span>
                            {% else %}
                            <span class="badge bg-warning">Unverified</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-4">Joined</dt>
                        <dd class="col-sm-8">{{ target_user.created_at[:19] if target_user.created_at else '-' }}</dd>

                        <dt class="col-sm-4">Account Age</dt>
                        <dd class="col-sm-8">{{ target_user.stats.account_age_days }} days</dd>
                    </dl>
                </div>
            </div>
        </div>

        <!-- Activity Statistics -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Activity Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3 text-center">
                        <div class="col-6">
                            <div class="p-3 bg-light rounded">
                                <h3 class="text-primary mb-1">{{ target_user.stats.entries }}</h3>
                                <small class="text-muted">Entries</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 bg-light rounded">
                                <h3 class="text-success mb-1">{{ target_user.stats.categories }}</h3>
                                <small class="text-muted">Categories</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 bg-light rounded">
                                <h3 class="text-warning mb-1">{{ target_user.stats.goals }}</h3>
                                <small class="text-muted">Goals</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 bg-light rounded">
                                <h3 class="text-info mb-1">{{ target_user.stats.recurring_payments }}</h3>
                                <small class="text-muted">Recurring Payments</small>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <dl class="row mb-0">
                            <dt class="col-sm-6">First Entry</dt>
                            <dd class="col-sm-6">{{ target_user.stats.first_entry_date or 'No entries' }}</dd>

                            <dt class="col-sm-6">Last Activity</dt>
                            <dd class="col-sm-6">{{ target_user.stats.last_entry_date[:19] if target_user.stats.last_entry_date else 'No entries' }}</dd>

                            <dt class="col-sm-6">AI Models</dt>
                            <dd class="col-sm-6">{{ target_user.stats.ai_models }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Actions -->
    {% if not target_user.is_admin %}
    <div class="row g-4 mt-2">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">Admin Actions</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Perform administrative actions on this user account.</p>
                    <div class="d-flex gap-2">
                        {% if not target_user.is_verified %}
                        <button class="btn btn-warning" onclick="resendVerification()">
                            <i class="bi bi-envelope"></i> Resend Verification
                        </button>
                        {% endif %}
                        <button class="btn btn-danger" onclick="confirmDeleteUser()">
                            <i class="bi bi-trash"></i> Delete Account
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
function resendVerification() {
    if (confirm('Resend verification email to {{ target_user.email }}?')) {
        fetch('/admin/users/{{ target_user.id }}/resend-verification', {
            method: 'POST',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Verification email sent successfully');
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error sending verification email');
            console.error(error);
        });
    }
}

function confirmDeleteUser() {
    const email = '{{ target_user.email }}';
    const entries = {{ target_user.stats.entries }};
    const categories = {{ target_user.stats.categories }};
    const goals = {{ target_user.stats.goals }};
    const recurringPayments = {{ target_user.stats.recurring_payments }};

    if (confirm(`Are you sure you want to delete user ${email}? This action cannot be undone and will delete all their data including:\n\n- ${entries} entries\n- ${categories} categories\n- ${goals} goals\n- ${recurringPayments} recurring payments\n- AI models and all other data`)) {
        if (confirm('This is your final confirmation. Delete user account?')) {
            fetch('/admin/users/{{ target_user.id }}/delete', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('User deleted successfully');
                    window.location.href = '/admin/users';
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error deleting user');
                console.error(error);
            });
        }
    }
}
</script>

<style>
/* User Details Styles */
.card {
    background: var(--panel);
    border: 1px solid var(--border);
}

.card-header {
    background: transparent;
    border-bottom: 1px solid var(--border);
}

dl dt {
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

dl dd {
    margin-bottom: 0.5rem;
}

.bg-light {
    background: var(--surface) !important;
}

/* Dark theme */
[data-theme="dark"] {
    color: #e5e7eb;
}

[data-theme="dark"] h1,
[data-theme="dark"] h2,
[data-theme="dark"] h3,
[data-theme="dark"] h4,
[data-theme="dark"] h5,
[data-theme="dark"] h6 {
    color: #f3f4f6;
}

[data-theme="dark"] .text-muted {
    color: #9ca3af !important;
}

[data-theme="dark"] .card {
    background: #1f2937;
    border-color: #374151;
}

[data-theme="dark"] .card-header {
    background: transparent;
    border-bottom-color: #374151;
    color: #e5e7eb;
}

[data-theme="dark"] .card-body {
    color: #e5e7eb;
}

[data-theme="dark"] dl dt {
    color: #9ca3af;
}

[data-theme="dark"] dl dd {
    color: #e5e7eb;
}

[data-theme="dark"] .bg-light {
    background: #374151 !important;
}

[data-theme="dark"] small {
    color: #d1d5db;
}

[data-theme="dark"] strong {
    color: #f3f4f6;
}

/* Light theme */
[data-theme="light"] {
    color: #1f2937;
}

[data-theme="light"] h1,
[data-theme="light"] h2,
[data-theme="light"] h3,
[data-theme="light"] h4,
[data-theme="light"] h5,
[data-theme="light"] h6 {
    color: #111827;
}

[data-theme="light"] .text-muted {
    color: #6b7280 !important;
}

[data-theme="light"] .card {
    background: #ffffff;
    border-color: #e5e7eb;
}

[data-theme="light"] .card-header {
    background: transparent;
    border-bottom-color: #e5e7eb;
    color: #1f2937;
}

[data-theme="light"] .card-body {
    color: #1f2937;
}

[data-theme="light"] dl dt {
    color: #6b7280;
}

[data-theme="light"] dl dd {
    color: #1f2937;
}

[data-theme="light"] .bg-light {
    background: #f3f4f6 !important;
}

[data-theme="light"] small {
    color: #6b7280;
}

[data-theme="light"] strong {
    color: #111827;
}
</style>
{% endblock %}
