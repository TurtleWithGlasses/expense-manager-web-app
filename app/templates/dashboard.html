{% extends "base.html" %}
{% block content %}

<style>
/* Initialize color variables immediately to prevent invisible text on page load */
:root {
  --income-color: #28a745;
  --expense-color: #dc3545;
}
</style>

<h1 class="h1">Welcome, {{ user.full_name or user.email.split('@')[0] }}</h1>

<!-- Navigation Links - Fixed with proper horizontal layout -->
<nav class="quick-links-horizontal" aria-label="Quick actions">
  <a class="btn ghost" href="/entries/" aria-label="Add, view, or edit expense entries">
    <i class="bi bi-plus-circle" aria-hidden="true"></i> Add / View / Edit Entries
  </a>
  <a class="btn ghost" href="/categories/" aria-label="Manage expense categories">
    <i class="bi bi-tags" aria-hidden="true"></i> Manage Categories
  </a>
  <a class="btn ghost" href="/calendar" aria-label="View calendar of financial entries">
    <i class="bi bi-calendar3" aria-hidden="true"></i> Calendar
  </a>
  <a class="btn ghost" href="/reports/" aria-label="View financial reports and analytics">
    <i class="bi bi-graph-up" aria-hidden="true"></i> Financial Reports
  </a>
  <a class="btn ghost" href="/insights/" aria-label="View smart financial insights and recommendations">
    <i class="bi bi-lightbulb" aria-hidden="true"></i> AI Insights
  </a>
  <a class="btn ghost" href="/goals/" aria-label="Set and track financial goals">
    <i class="bi bi-trophy" aria-hidden="true"></i> Goals
  </a>
  <a class="btn ghost" href="/intelligence/" aria-label="View smart budget recommendations and insights">
    <i class="bi bi-lightbulb-fill" aria-hidden="true"></i> Budget Intelligence
  </a>
  <a class="btn ghost" href="/currency/settings" aria-label="Change currency settings">
    <i class="bi bi-currency-exchange" aria-hidden="true"></i> Currency
  </a>
  <a class="btn ghost" href="/ai/settings" aria-label="Configure AI and machine learning settings">
    <i class="bi bi-robot" aria-hidden="true"></i> AI Settings
  </a>
</nav>
<!-- Horizontal date and category filters -->
<form id="filters" class="date-filters mt-6" onsubmit="return false" role="search" aria-label="Filter expenses by date and category">
  <div class="date-inputs">
    <div class="date-field">
      <label class="muted" for="start">Start date</label>
      <input id="start" name="start" type="date" class="input" value="{{ start or '' }}" aria-label="Filter start date">
    </div>
    <div class="date-field">
      <label class="muted" for="end">End date</label>
      <input id="end" name="end" type="date" class="input" value="{{ end or '' }}" aria-label="Filter end date">
    </div>
    <div class="date-field">
      <label class="muted" for="category">Category</label>
      <select id="category" name="category" class="input" aria-label="Filter by category">
        <option value="">All Categories</option>
        {% for category in categories %}
          <option value="{{ category.id }}" {% if selected_category and selected_category == category.id|string %}selected{% endif %}>
            {{ category.name }}
          </option>
        {% endfor %}
      </select>
    </div>
  </div>
</form>

<!-- Currency Display and Color Controls -->
<div class="controls-section mt-4">
  <!-- Currency Display -->
  <div class="currency-display">
    <span class="currency-label">Currency:</span>
    <span class="currency-value">
      {% if user_currency %}
        {{ user_currency.name }} ({{ user_currency.symbol }})
      {% else %}
        US Dollar ($)
      {% endif %}
    </span>
    <a href="/currency/settings" class="btn ghost mini">Change</a>
  </div>

  <!-- Color Picker Controls -->
  <div class="color-controls">
    <div class="color-picker-group">
      <label for="income-color">Income Color:</label>
      <input type="color" id="income-color" value="#28a745" onchange="updateIncomeColor(this.value)">
    </div>
    <div class="color-picker-group">
      <label for="expense-color">Expense Color:</label>
      <input type="color" id="expense-color" value="#dc3545" onchange="updateExpenseColor(this.value)">
    </div>
    <button class="btn ghost small" onclick="resetColors()">Reset Colors</button>
  </div>

  <!-- Export Controls -->
  <div class="export-controls">
    <div class="export-buttons">
      <button class="btn ghost small" onclick="exportToExcel()" title="Export detailed data to Excel">
        <i class="bi bi-file-earmark-excel"></i> Excel Report
      </button>
      <button class="btn ghost small" onclick="exportToPDF()" title="Export charts and summary to PDF">
        <i class="bi bi-file-earmark-pdf"></i> PDF Report
      </button>
      <button class="btn ghost small" onclick="exportCategorySummary()" title="Export category breakdown to Excel">
        <i class="bi bi-bar-chart"></i> Category Summary
      </button>
    </div>
  </div>
</div>

<!-- Weekly Summary Widget (Compact) -->
<div id="weekly-summary" class="mt-4" hx-get="/reports/weekly/summary" hx-trigger="load" hx-swap="innerHTML">
  <div class="muted">Loading weekly summary...</div>
</div>

<!-- AI Insights Widget -->
<div id="ai-insights-widget" class="mt-4" style="background: linear-gradient(135deg, rgba(77, 163, 255, 0.1) 0%, rgba(111, 66, 193, 0.1) 100%); border: 1px solid rgba(77, 163, 255, 0.3); border-radius: 14px; padding: 1.5rem;">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="h3 mb-0" style="color: #4da3ff;">
      <i class="bi bi-robot me-2"></i>
      AI Insights
    </h3>
    <button class="btn btn-sm btn-outline-info" onclick="refreshAIInsights()" title="Refresh insights">
      <i class="bi bi-arrow-clockwise"></i>
    </button>
  </div>

  <div id="ai-insights-content">
    <div class="muted">
      <i class="bi bi-hourglass-split me-2"></i>
      Loading AI insights...
    </div>
  </div>
</div>

<!-- Phase 15: Predictive Analytics Widget -->
<div id="predictive-analytics-widget" class="mt-4" style="background: linear-gradient(135deg, rgba(138, 43, 226, 0.1) 0%, rgba(75, 0, 130, 0.1) 100%); border: 1px solid rgba(138, 43, 226, 0.3); border-radius: 14px; padding: 1.5rem;">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="h3 mb-0" style="color: #ba55d3;">
      <i class="bi bi-graph-up-arrow me-2"></i>
      Predictive Analytics
    </h3>
    <button class="btn btn-sm btn-outline-info" onclick="refreshPredictiveAnalytics()" title="Refresh predictions">
      <i class="bi bi-arrow-clockwise"></i>
    </button>
  </div>

  <div id="predictive-content">
    <div class="muted">
      <i class="bi bi-hourglass-split me-2"></i>
      Loading predictions...
    </div>
  </div>
</div>

<!-- Phase 15: Anomaly Detection Widget -->
<div id="anomaly-detection-widget" class="mt-4" style="background: linear-gradient(135deg, rgba(255, 99, 71, 0.1) 0%, rgba(220, 20, 60, 0.1) 100%); border: 1px solid rgba(255, 99, 71, 0.3); border-radius: 14px; padding: 1.5rem;">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="h3 mb-0" style="color: #ff6347;">
      <i class="bi bi-exclamation-triangle me-2"></i>
      Anomaly Alerts
    </h3>
    <button class="btn btn-sm btn-outline-info" onclick="refreshAnomalies()" title="Refresh anomaly detection">
      <i class="bi bi-arrow-clockwise"></i>
    </button>
  </div>

  <div id="anomaly-content">
    <div class="muted">
      <i class="bi bi-hourglass-split me-2"></i>
      Checking for unusual patterns...
    </div>
  </div>
</div>

<!-- KPIs -->
<div id="totals" class="kpis mt-4" hx-get="/dashboard/summary" hx-include="#filters" hx-trigger="load, change from:#filters delay:150ms" hx-swap="innerHTML">
  <div class="muted">Loading totals...</div>
</div>

<!-- Incomes + Expenses -->
<div class="grid grid-2 mt-4">
  <section class="data-section income-section">
    <h2 class="h2">Income(s)</h2>
    <div id="income-list" hx-get="/dashboard/incomes" hx-include="#filters" hx-trigger="load, change from:#filters delay:150ms" hx-swap="innerHTML">
      <div class="muted">Loading incomes...</div>
    </div>
  </section>

  <section class="data-section expense-section">
    <h2 class="h2">Expenses</h2>
    <div id="expense-list" hx-get="/dashboard/expenses" hx-include="#filters" hx-trigger="load, change from:#filters delay:150ms" hx-swap="innerHTML">
      <div class="muted">Loading expenses...</div>
    </div>
  </section>
</div>

<!-- Chart area with tabs -->
<section class="chart-section mt-6" aria-labelledby="chart-heading">
  <!-- Chart tabs navigation -->
  <div class="chart-header">
    <h2 class="h2" id="chart-heading">Data Visualizations</h2>
    <div class="chart-tabs" role="tablist" aria-label="Chart type selector">
      <button class="chart-tab active" data-chart="pie" type="button" role="tab" aria-selected="true" aria-controls="chart-area" onclick="switchChart('pie')" hx-get="/metrics/chart/pie" hx-include="#filters" hx-target="#chart-area" hx-swap="innerHTML">
        <i class="bi bi-pie-chart" aria-hidden="true"></i>
        <span>Pie Chart</span>
      </button>
      <button class="chart-tab" data-chart="bar" type="button" role="tab" aria-selected="false" aria-controls="chart-area" onclick="switchChart('bar')" hx-get="/metrics/chart/bar" hx-include="#filters" hx-target="#chart-area" hx-swap="innerHTML">
        <i class="bi bi-bar-chart" aria-hidden="true"></i>
        <span>Bar Chart</span>
      </button>
      <button class="chart-tab" data-chart="daily" type="button" role="tab" aria-selected="false" aria-controls="chart-area" onclick="switchChart('daily')" hx-get="/metrics/chart/daily" hx-include="#filters" hx-target="#chart-area" hx-swap="innerHTML">
        <i class="bi bi-graph-up" aria-hidden="true"></i>
        <span>Daily Trend</span>
      </button>
    </div>
  </div>

  <!-- Chart display area with download button -->
  <div class="chart-display" id="chart-area" role="tabpanel" aria-live="polite" aria-label="Chart visualization area">
    <!-- Loading skeleton -->
    <div class="chart-skeleton" aria-label="Loading chart" role="status">
      <div class="skeleton-title"></div>
      <div class="skeleton-chart"></div>
      <div class="skeleton-legend"></div>
      <span class="sr-only">Loading chart data...</span>
    </div>
  </div>

  <!-- Chart actions bar -->
  <div class="chart-actions-bar" id="chart-actions" style="display: none;">
    <button class="btn-icon" onclick="downloadChart()" aria-label="Download chart as PNG image">
      <i class="bi bi-download" aria-hidden="true"></i>
      <span>Download PNG</span>
    </button>
    <button class="btn-icon" onclick="toggleChartLegend()" aria-label="Toggle chart legend visibility">
      <i class="bi bi-list-ul" aria-hidden="true"></i>
      <span>Toggle Legend</span>
    </button>
  </div>

  <!-- Close chart button -->
  <div class="chart-close-container" id="chart-close-container" style="display: none;">
    <button class="btn-close-chart" onclick="closeChartSection()" aria-label="Hide chart section">
      <i class="bi bi-x-circle" aria-hidden="true"></i>
      <span>Close Charts</span>
    </button>
  </div>
</section>

<style>
/* CSS Custom Properties for Dynamic Colors */
:root {
  --income-color: #28a745;
  --expense-color: #dc3545;
}

/* Navigation Links - Extended Horizontal Layout */
.quick-links-horizontal {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1rem;
  margin: 2rem 0;
  width: 100%;
}

.quick-links-horizontal .btn {
  text-align: center;
  white-space: nowrap;
  padding: 12px 16px;
  min-height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

/* Horizontal date filters layout */
.date-filters {
  display: flex;
  justify-content: flex-start;
  align-items: flex-end;
  gap: 2rem;
  flex-wrap: wrap;
}

.date-inputs {
  display: flex;
  gap: 1rem;
  align-items: flex-end;
}

.date-field {
  display: flex;
  flex-direction: column;
}

.date-field label {
  margin-bottom: 0.25rem;
  font-size: 0.875rem;
}

/* Controls section styling */
.controls-section {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 2rem;
  flex-wrap: wrap;
  padding: 1rem;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

/* Currency display styling */
.currency-display {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex-wrap: wrap;
  min-width: 200px;
}

.currency-label {
  font-size: 0.875rem;
  color: #9ca3af;
}

.currency-value {
  font-size: 1rem;
  color: #10b981;
  font-weight: 600;
}

.btn.mini {
  padding: 0.25rem 0.75rem;
  font-size: 0.75rem;
}

/* Color picker controls */
.color-controls {
  display: flex;
  align-items: center;
  gap: 1.5rem;
  flex-wrap: wrap;
}

.color-picker-group {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.color-picker-group label {
  font-size: 0.875rem;
  color: #ccc;
  white-space: nowrap;
}

.color-picker-group input[type="color"] {
  width: 40px;
  height: 30px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.btn.small {
  padding: 0.5rem 1rem;
  font-size: 0.875rem;
}

/* Data sections styling */
.data-section {
  background: transparent;
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  padding: 1.5rem;
  backdrop-filter: blur(10px);
  min-height: auto !important; /* Ensure section can grow */
  height: auto !important; /* Allow dynamic height */
  overflow: visible !important; /* Show all content */
}

#income-list, #expense-list {
  min-height: auto !important;
  height: auto !important;
  max-height: none !important; /* Remove any height restrictions */
  overflow: visible !important; /* Show all content */
  opacity: 1 !important; /* Ensure containers are fully visible */
  animation: none !important; /* Disable any fade-in animations */
}

#income-list table, #expense-list table {
  animation: none !important; /* Disable table fade-in animation */
  opacity: 1 !important;
}

#income-list tbody, #expense-list tbody {
  animation: none !important;
  opacity: 1 !important;
}

.data-section h2 {
  margin-bottom: 1rem;
  color: #fff;
}

/* Apply colors to income and expense content */
.income-section td,
.income-section .amount,
.income-section .total-amount,
.income-section table tbody tr td {
  color: var(--income-color) !important;
}

.expense-section td,
.expense-section .amount,
.expense-section .total-amount,
.expense-section table tbody tr td {
  color: var(--expense-color) !important;
}

/* Table styling */
.data-section table {
  width: 100%;
  border-collapse: collapse;
  background: transparent;
}

.data-section th,
.data-section td {
  padding: 0.75rem;
  text-align: left;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  background: transparent;
  color: #e5e7eb; /* Ensure text is visible on dark background */
}

.data-section th {
  font-weight: 600;
  color: #ccc !important;
  font-size: 0.875rem;
}

/* Disable fade-in animation for dashboard tables */
.data-section table,
.data-section tbody,
.data-section tbody tr,
.data-section tbody tr td {
  animation: none !important; /* Disable any fade-in animations */
  opacity: 1 !important; /* Force full visibility */
  visibility: visible !important;
}

.data-section .total-row {
  font-weight: 600;
  border-top: 2px solid rgba(255, 255, 255, 0.2);
}

/* Chart section styling */
.chart-section {
  background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
  border-radius: 12px;
  padding: 0;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(255, 255, 255, 0.1);
  overflow: hidden;
}

.chart-header {
  background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
  padding: 1.25rem 1.5rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.chart-header h2 {
  color: #fff;
  margin: 0 0 0.75rem 0;
  font-size: 1.25rem;
  font-weight: 600;
}

/* Chart tabs navigation */
.chart-tabs {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.chart-tab {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.25rem;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  color: #cbd5e1;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}

.chart-tab:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(255, 255, 255, 0.2);
  color: #fff;
  transform: translateY(-1px);
}

.chart-tab.active {
  background: #4da3ff;
  border-color: #4da3ff;
  color: #fff;
  box-shadow: 0 4px 12px rgba(77, 163, 255, 0.3);
}

.chart-tab i {
  font-size: 1.125rem;
}

/* Chart display area */
.chart-display {
  padding: 1.5rem;
  min-height: 200px;
  background: rgba(255, 255, 255, 0.02);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: min-height 0.3s ease;
}

.chart-display.has-chart {
  min-height: 400px;
}

/* Loading skeleton */
.chart-skeleton {
  width: 100%;
  max-width: 800px;
  animation: pulse 1.5s ease-in-out infinite;
}

.skeleton-title {
  height: 24px;
  width: 40%;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 4px;
  margin-bottom: 1.5rem;
}

.skeleton-chart {
  height: 150px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  margin-bottom: 1rem;
}

.skeleton-legend {
  height: 40px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

/* Chart actions bar */
.chart-actions-bar {
  display: flex;
  gap: 0.75rem;
  padding: 1rem 1.5rem;
  background: rgba(255, 255, 255, 0.03);
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  justify-content: flex-end;
}

.btn-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0;
  padding: 0.5rem;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 6px;
  color: #cbd5e1;
  font-size: 0.8125rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  white-space: nowrap;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  overflow: hidden;
  position: relative;
}

.btn-icon:hover {
  background: rgba(77, 163, 255, 0.15);
  border-color: rgba(77, 163, 255, 0.3);
  color: #4da3ff;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(77, 163, 255, 0.2);
  gap: 0.375rem;
  padding: 0.5rem 0.875rem;
}

.btn-icon:active {
  transform: translateY(0);
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.btn-icon i {
  font-size: 1rem;
  flex-shrink: 0;
  line-height: 1;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.btn-icon span {
  line-height: 1;
  font-size: 0.8125rem;
  max-width: 0;
  opacity: 0;
  overflow: hidden;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.btn-icon:hover span {
  max-width: 150px;
  opacity: 1;
  margin-left: 0.375rem;
}

/* Close chart button container */
.chart-close-container {
  display: flex;
  justify-content: center;
  padding: 1rem 1.5rem;
  background: rgba(255, 255, 255, 0.02);
  border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.btn-close-chart {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.375rem;
  padding: 0.5rem 1rem;
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.25);
  border-radius: 6px;
  color: #f87171;
  font-size: 0.8125rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  white-space: nowrap;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.btn-close-chart:hover {
  background: rgba(239, 68, 68, 0.2);
  border-color: rgba(239, 68, 68, 0.5);
  color: #fca5a5;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.btn-close-chart:active {
  transform: translateY(0);
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.btn-close-chart i {
  font-size: 0.9375rem;
  flex-shrink: 0;
  line-height: 1;
}

.btn-close-chart span {
  line-height: 1;
  font-size: 0.8125rem;
}

/* Mobile Responsive Design */
@media (max-width: 768px) {
  /* Navigation links - stack vertically on mobile */
  .quick-links-horizontal {
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }
  
  .quick-links-horizontal .btn {
    padding: 14px 16px;
    min-height: 48px;
    font-size: 0.9rem;
  }
  
  /* Date filters - stack vertically on mobile */
  .date-filters {
    flex-direction: column;
    align-items: stretch;
    gap: 1rem;
  }
  
  .date-inputs {
    flex-direction: column;
    gap: 1rem;
  }
  
  .date-field {
    width: 100%;
  }
  
  .date-field .input {
    width: 100%;
    padding: 12px;
    font-size: 16px; /* Prevents zoom on iOS */
  }
  
  /* Controls section - stack vertically */
  .controls-section {
    flex-direction: column;
    align-items: stretch;
    gap: 1.5rem;
    padding: 1.5rem;
  }
  
  .currency-display {
    justify-content: center;
    text-align: center;
  }
  
  .color-controls {
    justify-content: center;
    flex-wrap: wrap;
    gap: 1rem;
  }
  
  /* Export buttons - make them larger and stack */
  .export-controls {
    width: 100%;
  }
  
  .export-buttons {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }
  
  .export-buttons .btn {
    padding: 12px 16px;
    min-height: 48px;
    font-size: 0.9rem;
    justify-content: center;
  }
  
  /* Summary cards - stack vertically on mobile */
  .kpis {
    display: flex !important;
    flex-direction: column !important;
    gap: 1rem !important;
  }
  
  .kpi {
    width: 100% !important;
    margin: 0 !important;
  }
  
  /* Income/Expenses tables - stack vertically on mobile */
  .grid-2 {
    display: flex !important;
    flex-direction: column !important;
    gap: 1.5rem !important;
  }
  
  .data-section {
    width: 100% !important;
    margin: 0 !important;
  }
  
  /* Make tables more mobile-friendly */
  .data-section table {
    font-size: 0.9rem;
  }
  
  .data-section th,
  .data-section td {
    padding: 0.75rem 0.5rem;
    word-break: break-word;
  }
  
  /* Chart section mobile optimization */
  .chart-header {
    flex-direction: column;
    align-items: stretch;
    text-align: center;
    gap: 1rem;
  }
  
  .chart-actions {
    justify-content: center;
    flex-wrap: wrap;
    gap: 0.75rem;
  }
  
  .chart-actions .btn {
    padding: 10px 16px;
    min-height: 44px;
    font-size: 0.85rem;
  }
  
  .chart-display {
    padding: 1.5rem;
    min-height: 250px;
  }

  .chart-tabs {
    flex-direction: column;
    gap: 0.5rem;
  }

  .chart-tab {
    width: 100%;
    justify-content: center;
    padding: 1rem;
  }

  .chart-actions-bar {
    flex-direction: column;
    gap: 0.5rem;
  }

  .btn-icon {
    width: 100%;
    justify-content: center;
    gap: 0.375rem;
    padding: 0.5rem 0.875rem;
  }

  .btn-icon span {
    max-width: 150px;
    opacity: 1;
    margin-left: 0.375rem;
  }
}

@media (max-width: 480px) {
  /* Extra small screens */
  .quick-links-horizontal .btn {
    padding: 16px;
    min-height: 52px;
    font-size: 1rem;
  }
  
  .date-field .input {
    padding: 14px;
    font-size: 16px;
  }
  
  .export-buttons .btn {
    padding: 14px 16px;
    min-height: 52px;
    font-size: 1rem;
  }
  
  .data-section {
    padding: 1rem;
  }
  
  .data-section th,
  .data-section td {
    padding: 0.5rem 0.25rem;
    font-size: 0.85rem;
  }
  
  .chart-actions .btn {
    padding: 12px 14px;
    min-height: 48px;
    font-size: 0.8rem;
  }
}

/* =============================================
   LIGHT THEME - CHART SECTION
   ============================================= */
[data-theme="light"] .chart-section {
  background: #ffffff;
  border: 1px solid #dee2e6;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

[data-theme="light"] .chart-header {
  background: #f8f9fa;
  border-bottom: 2px solid #dee2e6;
}

[data-theme="light"] .chart-header h2 {
  color: #212529;
}

[data-theme="light"] .chart-tab {
  background: #ffffff;
  border-color: #ced4da;
  color: #495057;
}

[data-theme="light"] .chart-tab:hover {
  background: #e9ecef;
  border-color: #adb5bd;
  color: #212529;
}

[data-theme="light"] .chart-tab.active {
  background: #0d6efd;
  border-color: #0d6efd;
  color: #ffffff;
  box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
}

[data-theme="light"] .chart-display {
  background: #f8f9fa;
}

[data-theme="light"] .skeleton-title,
[data-theme="light"] .skeleton-chart,
[data-theme="light"] .skeleton-legend {
  background: #e9ecef;
}

[data-theme="light"] .chart-actions-bar {
  background: #f8f9fa;
  border-top: 2px solid #dee2e6;
}

[data-theme="light"] .btn-icon {
  background: #ffffff;
  border-color: #ced4da;
  color: #495057;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
}

[data-theme="light"] .btn-icon:hover {
  background: rgba(13, 110, 253, 0.1);
  border-color: rgba(13, 110, 253, 0.3);
  color: #0d6efd;
  box-shadow: 0 4px 8px rgba(13, 110, 253, 0.15);
  gap: 0.375rem;
  padding: 0.5rem 0.875rem;
}

[data-theme="light"] .btn-icon:active {
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
}

[data-theme="light"] .btn-icon:hover span {
  max-width: 150px;
  opacity: 1;
  margin-left: 0.375rem;
}

[data-theme="light"] .chart-close-container {
  background: #f8f9fa;
  border-top: 2px solid #e9ecef;
}

[data-theme="light"] .btn-close-chart {
  background: rgba(220, 53, 69, 0.1);
  border-color: rgba(220, 53, 69, 0.25);
  color: #dc3545;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
}

[data-theme="light"] .btn-close-chart:hover {
  background: rgba(220, 53, 69, 0.15);
  border-color: rgba(220, 53, 69, 0.5);
  color: #b02a37;
  box-shadow: 0 4px 12px rgba(220, 53, 69, 0.25);
}

[data-theme="light"] .btn-close-chart:active {
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
}

/* Light Theme - Anomaly Detection Widget */
[data-theme="light"] #anomaly-detection-widget {
  background: linear-gradient(135deg, rgba(255, 99, 71, 0.08) 0%, rgba(220, 20, 60, 0.08) 100%) !important;
  border: 1px solid rgba(255, 99, 71, 0.25) !important;
}

[data-theme="light"] #anomaly-detection-widget h3 {
  color: #dc3545 !important;
}

[data-theme="light"] .anomaly-card {
  background: rgba(255, 255, 255, 0.9) !important;
  border: 1px solid rgba(0, 0, 0, 0.1) !important;
}

[data-theme="light"] .anomaly-card h6 {
  color: #dc3545 !important;
}

[data-theme="light"] .anomaly-card .mb-2,
[data-theme="light"] .anomaly-card div[style*="color: #ccc"],
[data-theme="light"] .anomaly-card div[style*="color: #999"],
[data-theme="light"] .anomaly-card div[style*="color: #aaa"] {
  color: #495057 !important;
}

/* Anomaly transaction cards in light mode */
[data-theme="light"] .anomaly-card > div[style*="display: flex; flex-direction: column"] > div {
  background: rgba(248, 249, 250, 0.8) !important;
  border: 1px solid rgba(0, 0, 0, 0.12) !important;
}

[data-theme="light"] .anomaly-card div[style*="font-weight: 600; color: #fff"] {
  color: #212529 !important;
}

[data-theme="light"] .anomaly-card div[style*="color: #ccc"],
[data-theme="light"] .anomaly-card div[style*="font-size: 0.85rem; color: #ccc"] {
  color: #6c757d !important;
}

[data-theme="light"] .anomaly-card div[style*="color: #aaa"],
[data-theme="light"] .anomaly-card div[style*="font-size: 0.8rem; color: #aaa"] {
  color: #495057 !important;
}

[data-theme="light"] .anomaly-card div[style*="color: #999"] {
  color: #6c757d !important;
}

[data-theme="light"] .anomaly-card .btn-sm {
  background: rgba(220, 53, 69, 0.1) !important;
  border: 1px solid rgba(220, 53, 69, 0.3) !important;
  color: #dc3545 !important;
}

[data-theme="light"] .anomaly-card .btn-sm:hover {
  background: rgba(220, 53, 69, 0.2) !important;
  border: 1px solid rgba(220, 53, 69, 0.5) !important;
}
</style>

<script>
// Get user's currency symbol from template
const CURRENCY_SYMBOL = '{% if user_currency %}{{ user_currency.symbol }}{% else %}${% endif %}';

// Dashboard Load More functionality
let incomeOffset = 0;
let expenseOffset = 0;
const paginationLimit = 10;

async function loadMoreIncomes() {
    const btn = document.getElementById('income-load-more-btn');
    const loading = document.getElementById('income-load-more-loading');
    const container = document.getElementById('income-load-more-container');
    const tbody = document.getElementById('income-list-tbody');

    if (!btn || !loading || !tbody) return;

    // Show loading state
    btn.style.display = 'none';
    loading.style.display = 'block';

    // Calculate new offset
    incomeOffset += paginationLimit;

    // Build URL with query parameters from filters
    const start = document.getElementById('start').value;
    const end = document.getElementById('end').value;
    const category = document.getElementById('category').value;

    const params = new URLSearchParams();
    params.append('offset', incomeOffset);
    params.append('limit', paginationLimit);
    if (start) params.append('start', start);
    if (end) params.append('end', end);
    if (category) params.append('category', category);

    try {
        const response = await fetch(`/dashboard/incomes?${params.toString()}`);
        if (!response.ok) throw new Error('Failed to load incomes');

        const html = await response.text();

        // Parse the response to extract only the tbody rows
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        const newRows = tempDiv.querySelector('#income-list-tbody');

        if (newRows && newRows.children.length > 0) {
            // Append new rows
            Array.from(newRows.children).forEach(row => {
                tbody.appendChild(row);
            });

            // Update the "Showing X to Y of Z" counter
            // Calculate the actual showing count based on loaded rows
            const totalLoadedRows = tbody.children.length;
            const counterElement = document.getElementById('income-summary-text');
            if (counterElement) {
                // Extract total count from the response
                const showingText = tempDiv.querySelector('#income-summary-text');
                if (showingText) {
                    const match = showingText.textContent.match(/of (\d+) incomes/);
                    if (match) {
                        const totalCount = parseInt(match[1]);
                        counterElement.textContent = `Showing 1 to ${totalLoadedRows} of ${totalCount} incomes`;
                    }
                }
            }

            // Check if there are more entries (button will be in the response)
            const newContainer = tempDiv.querySelector('#income-load-more-container');
            if (newContainer) {
                // Update button state
                const remainingBadge = newContainer.querySelector('#income-remaining-count');
                if (remainingBadge) {
                    document.getElementById('income-remaining-count').textContent = remainingBadge.textContent;
                }
                btn.style.display = 'inline-block';
                loading.style.display = 'none';
            } else {
                // No more entries, hide container
                container.style.display = 'none';
            }
        } else {
            // No more rows
            container.style.display = 'none';
        }
    } catch (error) {
        console.error('Error loading more incomes:', error);
        btn.style.display = 'inline-block';
        loading.style.display = 'none';
    }
}

async function loadMoreExpenses() {
    const btn = document.getElementById('expense-load-more-btn');
    const loading = document.getElementById('expense-load-more-loading');
    const container = document.getElementById('expense-load-more-container');
    const tbody = document.getElementById('expense-list-tbody');

    if (!btn || !loading || !tbody) return;

    // Show loading state
    btn.style.display = 'none';
    loading.style.display = 'block';

    // Calculate new offset
    expenseOffset += paginationLimit;

    // Build URL with query parameters from filters
    const start = document.getElementById('start').value;
    const end = document.getElementById('end').value;
    const category = document.getElementById('category').value;

    const params = new URLSearchParams();
    params.append('offset', expenseOffset);
    params.append('limit', paginationLimit);
    if (start) params.append('start', start);
    if (end) params.append('end', end);
    if (category) params.append('category', category);

    try {
        const response = await fetch(`/dashboard/expenses?${params.toString()}`);
        if (!response.ok) throw new Error('Failed to load expenses');

        const html = await response.text();

        // Parse the response to extract only the tbody rows
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        const newRows = tempDiv.querySelector('#expense-list-tbody');

        if (newRows && newRows.children.length > 0) {
            // Append new rows
            Array.from(newRows.children).forEach(row => {
                tbody.appendChild(row);
            });

            // Update the "Showing X to Y of Z" counter
            // Calculate the actual showing count based on loaded rows
            const totalLoadedRows = tbody.children.length;
            const counterElement = document.getElementById('expense-summary-text');
            if (counterElement) {
                // Extract total count from the response
                const showingText = tempDiv.querySelector('#expense-summary-text');
                if (showingText) {
                    const match = showingText.textContent.match(/of (\d+) expenses/);
                    if (match) {
                        const totalCount = parseInt(match[1]);
                        counterElement.textContent = `Showing 1 to ${totalLoadedRows} of ${totalCount} expenses`;
                    }
                }
            }

            // Check if there are more entries (button will be in the response)
            const newContainer = tempDiv.querySelector('#expense-load-more-container');
            if (newContainer) {
                // Update button state
                const remainingBadge = newContainer.querySelector('#expense-remaining-count');
                if (remainingBadge) {
                    document.getElementById('expense-remaining-count').textContent = remainingBadge.textContent;
                }
                btn.style.display = 'inline-block';
                loading.style.display = 'none';
            } else {
                // No more entries, hide container
                container.style.display = 'none';
            }
        } else {
            // No more rows
            container.style.display = 'none';
        }
    } catch (error) {
        console.error('Error loading more expenses:', error);
        btn.style.display = 'inline-block';
        loading.style.display = 'none';
    }
}

// Reset offsets when filters change
document.addEventListener('DOMContentLoaded', function() {
    const filters = document.getElementById('filters');
    if (filters) {
        const inputs = filters.querySelectorAll('input, select');
        inputs.forEach(input => {
            input.addEventListener('change', function() {
                incomeOffset = 0;
                expenseOffset = 0;
            });
        });
    }
});

function updateIncomeColor(color) {
  document.documentElement.style.setProperty('--income-color', color);
  localStorage.setItem('income-color', color);
}

function updateExpenseColor(color) {
  document.documentElement.style.setProperty('--expense-color', color);
  localStorage.setItem('expense-color', color);
}

function resetColors() {
  const defaultIncome = '#28a745';
  const defaultExpense = '#dc3545';
  
  document.getElementById('income-color').value = defaultIncome;
  document.getElementById('expense-color').value = defaultExpense;
  
  updateIncomeColor(defaultIncome);
  updateExpenseColor(defaultExpense);
  
  localStorage.removeItem('income-color');
  localStorage.removeItem('expense-color');
}

// Load saved colors on page load
document.addEventListener('DOMContentLoaded', function() {
  const savedIncome = localStorage.getItem('income-color');
  const savedExpense = localStorage.getItem('expense-color');
  
  if (savedIncome) {
    document.getElementById('income-color').value = savedIncome;
    updateIncomeColor(savedIncome);
  }
  
  if (savedExpense) {
    document.getElementById('expense-color').value = savedExpense;
    updateExpenseColor(savedExpense);
  }
});

// Export functions
function getCurrentFilters() {
  const start = document.getElementById('start').value;
  const end = document.getElementById('end').value;
  const category = document.getElementById('category').value;
  
  const params = new URLSearchParams();
  if (start) params.append('start', start);
  if (end) params.append('end', end);
  if (category) params.append('category', category);
  
  return params.toString();
}

function exportToExcel() {
  const filters = getCurrentFilters();
  const url = `/reports/excel/entries?${filters}`;
  window.open(url, '_blank');
}

function exportToPDF() {
  const filters = getCurrentFilters();
  const url = `/reports/pdf/financial?${filters}`;
  window.open(url, '_blank');
}

function exportCategorySummary() {
  const filters = getCurrentFilters();
  const url = `/reports/excel/categories?${filters}`;
  window.open(url, '_blank');
}

// ============================================
// CHART FUNCTIONS - Phase 5
// ============================================

// Store current chart instance globally
let currentChartInstance = null;
let currentChartType = 'pie';

// Switch between charts and update tab states
function switchChart(chartType) {
  currentChartType = chartType;

  // Update active tab and ARIA states
  document.querySelectorAll('.chart-tab').forEach(tab => {
    tab.classList.remove('active');
    tab.setAttribute('aria-selected', 'false');
  });

  const activeTab = document.querySelector(`[data-chart="${chartType}"]`);
  activeTab.classList.add('active');
  activeTab.setAttribute('aria-selected', 'true');

  // Add has-chart class to expand the chart area
  const chartArea = document.getElementById('chart-area');
  chartArea.classList.add('has-chart');

  // Show chart actions bar and close button
  document.getElementById('chart-actions').style.display = 'flex';
  document.getElementById('chart-close-container').style.display = 'flex';
}

// Close/hide the chart display area only (not the entire section)
function closeChartSection() {
  const chartArea = document.getElementById('chart-area');

  // Remove has-chart class to collapse the chart area
  chartArea.classList.remove('has-chart');

  // Add fade-out animation to chart area
  chartArea.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
  chartArea.style.opacity = '0';
  chartArea.style.transform = 'scale(0.95)';

  // Hide chart content after animation (keep buttons visible)
  setTimeout(() => {
    // Reset chart area to loading skeleton
    chartArea.innerHTML = `
      <div class="chart-skeleton" aria-label="Loading chart" role="status">
        <div class="skeleton-title"></div>
        <div class="skeleton-chart"></div>
        <div class="skeleton-legend"></div>
        <span class="sr-only">Select a chart type above to view data...</span>
      </div>
    `;

    // Reset opacity and transform
    chartArea.style.opacity = '1';
    chartArea.style.transform = 'scale(1)';

    // Reset active tab states
    document.querySelectorAll('.chart-tab').forEach(tab => {
      tab.classList.remove('active');
      tab.setAttribute('aria-selected', 'false');
    });

    // Hide chart actions bar and close button
    document.getElementById('chart-actions').style.display = 'none';
    document.getElementById('chart-close-container').style.display = 'none';

    // Show info message
    if (typeof Toast !== 'undefined') {
      Toast.info('Chart closed. Select a chart type to view data.', 'Chart Closed');
    }
  }, 300);
}

// Download current chart as PNG
function downloadChart() {
  const canvas = document.querySelector('#chart-area canvas');
  if (!canvas) {
    Toast.warning('Please load a chart first.', 'No Chart Available');
    return;
  }

  try {
    // Create download link
    const link = document.createElement('a');
    const filename = `expense-chart-${currentChartType}-${new Date().toISOString().split('T')[0]}.png`;
    link.download = filename;
    link.href = canvas.toDataURL('image/png');
    link.click();

    // Show success toast
    Toast.success(`Chart downloaded as ${filename}`, 'Download Complete');
  } catch (error) {
    console.error('Error downloading chart:', error);
    Toast.error('Failed to download chart. Please try again.', 'Download Failed');
  }
}

// Toggle chart legend visibility
function toggleChartLegend() {
  if (window.dailyChartInstance) {
    const legendPlugin = window.dailyChartInstance.options.plugins.legend;
    legendPlugin.display = !legendPlugin.display;
    window.dailyChartInstance.update();
  }
}

// Listen for HTMX events to handle chart loading
document.addEventListener('htmx:beforeRequest', function(event) {
  if (event.detail.target.id === 'chart-area') {
    // Show loading skeleton
    event.detail.target.innerHTML = `
      <div class="chart-skeleton">
        <div class="skeleton-title"></div>
        <div class="skeleton-chart"></div>
        <div class="skeleton-legend"></div>
      </div>
    `;
  }
});

document.addEventListener('htmx:afterSwap', function(event) {
  if (event.detail.target.id === 'chart-area') {
    // Chart loaded, show actions bar and close button
    document.getElementById('chart-actions').style.display = 'flex';
    document.getElementById('chart-close-container').style.display = 'flex';
  }
});

// Auto-load pie chart on page load
document.addEventListener('DOMContentLoaded', function() {
  // Trigger the first chart load (pie chart)
  const pieChartButton = document.querySelector('[data-chart="pie"]');
  if (pieChartButton) {
    pieChartButton.click();
  }

  // Load AI insights
  loadAIInsights();

  // Load Predictive Analytics (Phase 15)
  loadPredictiveAnalytics();

  // Load Anomaly Detection (Phase 15)
  loadAnomalyDetection();
});

// ============================================
// AI INSIGHTS WIDGET - Phase 14
// ============================================

async function loadAIInsights() {
    const contentDiv = document.getElementById('ai-insights-content');

    try {
        const response = await fetch('/ai/insights');
        const data = await response.json();

        if (data.success && data.insights) {
            displayAIInsights(data.insights);
        } else {
            contentDiv.innerHTML = `
                <div class="alert alert-warning" style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3);">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Unable to load AI insights. Try adding more entries to enable AI analysis.
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading AI insights:', error);
        contentDiv.innerHTML = `
            <div class="alert alert-danger" style="background: rgba(220, 53, 69, 0.1); border: 1px solid rgba(220, 53, 69, 0.3);">
                <i class="bi bi-x-circle me-2"></i>
                Failed to load AI insights. Please try again later.
            </div>
        `;
    }
}

function displayAIInsights(insights) {
    const contentDiv = document.getElementById('ai-insights-content');

    let html = '<div class="ai-insights-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">';

    // Top Categories Insight
    if (insights.top_categories && insights.top_categories.length > 0) {
        html += `
            <div class="insight-card" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 1rem;">
                <h6 style="color: #4da3ff; margin-bottom: 0.75rem;">
                    <i class="bi bi-trophy me-2"></i>
                    Top Spending Categories
                </h6>
                <div>
        `;

        insights.top_categories.slice(0, 3).forEach((cat, idx) => {
            const icons = ['1-circle-fill', '2-circle-fill', '3-circle-fill'];
            html += `
                <div class="d-flex align-items-center justify-content-between mb-2" style="font-size: 0.9rem;">
                    <span>
                        <i class="bi bi-${icons[idx]} me-2" style="color: #4da3ff;"></i>
                        ${cat.name}
                    </span>
                    <strong style="color: #fca5a5;">${cat.total}${CURRENCY_SYMBOL}</strong>
                </div>
            `;
        });

        html += '</div></div>';
    }

    // Spending Trend Insight
    if (insights.trend) {
        const trendIcon = insights.trend === 'increasing' ? 'arrow-up-circle' : 'arrow-down-circle';
        const trendColor = insights.trend === 'increasing' ? '#fca5a5' : '#86efac';

        html += `
            <div class="insight-card" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 1rem;">
                <h6 style="color: #4da3ff; margin-bottom: 0.75rem;">
                    <i class="bi bi-graph-up me-2"></i>
                    Spending Trend
                </h6>
                <div class="d-flex align-items-center">
                    <i class="bi bi-${trendIcon}" style="font-size: 2rem; color: ${trendColor}; margin-right: 0.75rem;"></i>
                    <div>
                        <div style="font-size: 0.9rem; color: #ccc;">Your spending is</div>
                        <strong style="font-size: 1.1rem; color: ${trendColor}; text-transform: capitalize;">${insights.trend}</strong>
                    </div>
                </div>
            </div>
        `;
    }

    // Recommendation Insight
    if (insights.recommendation) {
        html += `
            <div class="insight-card" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 1rem;">
                <h6 style="color: #4da3ff; margin-bottom: 0.75rem;">
                    <i class="bi bi-lightbulb me-2"></i>
                    AI Recommendation
                </h6>
                <p style="font-size: 0.9rem; color: #ccc; margin: 0;">
                    ${insights.recommendation}
                </p>
            </div>
        `;
    }

    // Uncategorized Entries Alert
    if (insights.uncategorized_count && insights.uncategorized_count > 0) {
        html += `
            <div class="insight-card" style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px; padding: 1rem;">
                <h6 style="color: #ffc107; margin-bottom: 0.75rem;">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Action Needed
                </h6>
                <p style="font-size: 0.9rem; color: #ccc; margin-bottom: 0.5rem;">
                    You have <strong>${insights.uncategorized_count}</strong> uncategorized entries
                </p>
                <a href="/entries" class="btn btn-sm btn-warning">
                    <i class="bi bi-robot me-1"></i>
                    AI Categorize
                </a>
            </div>
        `;
    }

    html += '</div>';
    contentDiv.innerHTML = html;
}

function refreshAIInsights() {
    const contentDiv = document.getElementById('ai-insights-content');
    contentDiv.innerHTML = `
        <div class="muted">
            <i class="bi bi-hourglass-split me-2"></i>
            Refreshing AI insights...
        </div>
    `;
    loadAIInsights();
}

// ============================================
// PHASE 15: PREDICTIVE ANALYTICS WIDGET
// ============================================

async function loadPredictiveAnalytics() {
    const contentDiv = document.getElementById('predictive-content');

    try {
        // Fetch next month prediction and budget status in parallel
        const [predictionResponse, budgetResponse] = await Promise.all([
            fetch('/ai/predictions/next-month'),
            fetch('/ai/predictions/budget-status')
        ]);

        const predictionData = await predictionResponse.json();
        const budgetData = await budgetResponse.json();

        if (predictionData.success || budgetData.success) {
            displayPredictiveAnalytics(predictionData, budgetData);
        } else {
            contentDiv.innerHTML = `
                <div class="alert alert-warning" style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3);">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Need more historical data for predictions. Add at least 10 expense entries.
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading predictions:', error);
        contentDiv.innerHTML = `
            <div class="alert alert-danger" style="background: rgba(220, 53, 69, 0.1); border: 1px solid rgba(220, 53, 69, 0.3);">
                <i class="bi bi-x-circle me-2"></i>
                Failed to load predictions. Please try again later.
            </div>
        `;
    }
}

function displayPredictiveAnalytics(predictionData, budgetData) {
    const contentDiv = document.getElementById('predictive-content');

    let html = '<div class="predictions-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">';

    // Next Month Prediction Card
    if (predictionData.success && predictionData.prediction) {
        const pred = predictionData.prediction;
        const trend = predictionData.historical_data.trend;
        const trendIcon = trend === 'increasing' ? 'arrow-up-circle' : trend === 'decreasing' ? 'arrow-down-circle' : 'dash-circle';
        const trendColor = trend === 'increasing' ? '#fca5a5' : trend === 'decreasing' ? '#86efac' : '#fbbf24';

        html += `
            <div class="prediction-card" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 1rem;">
                <h6 style="color: #ba55d3; margin-bottom: 0.75rem;">
                    <i class="bi bi-calendar-check me-2"></i>
                    Next Month Forecast
                </h6>
                <div style="margin-bottom: 0.75rem;">
                    <div style="font-size: 0.85rem; color: #999; margin-bottom: 0.25rem;">${pred.month}</div>
                    <div style="font-size: 1.8rem; font-weight: bold; color: #ba55d3; margin-bottom: 0.25rem;">
                        ${pred.amount.toLocaleString()}${CURRENCY_SYMBOL}
                    </div>
                    <div style="font-size: 0.75rem; color: #999;">
                        Range: ${pred.confidence_interval.lower.toLocaleString()}${CURRENCY_SYMBOL} - ${pred.confidence_interval.upper.toLocaleString()}${CURRENCY_SYMBOL}
                    </div>
                </div>
                <div class="d-flex align-items-center" style="font-size: 0.85rem;">
                    <i class="bi bi-${trendIcon}" style="color: ${trendColor}; margin-right: 0.5rem;"></i>
                    <span style="color: #ccc;">Trend: </span>
                    <strong style="color: ${trendColor}; margin-left: 0.25rem; text-transform: capitalize;">${trend}</strong>
                </div>
            </div>
        `;
    }

    // Current Month Budget Status Card
    if (budgetData.success) {
        const statusColors = {
            'on_track': '#86efac',
            'over_budget': '#fca5a5',
            'under_budget': '#93c5fd'
        };
        const statusIcons = {
            'on_track': 'check-circle',
            'over_budget': 'exclamation-circle',
            'under_budget': 'arrow-down-circle'
        };
        const statusLabels = {
            'on_track': 'On Track',
            'over_budget': 'Over Budget',
            'under_budget': 'Under Budget'
        };

        const status = budgetData.status;
        const color = statusColors[status] || '#999';
        const icon = statusIcons[status] || 'dash-circle';
        const label = statusLabels[status] || 'Unknown';

        html += `
            <div class="prediction-card" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 1rem;">
                <h6 style="color: #ba55d3; margin-bottom: 0.75rem;">
                    <i class="bi bi-speedometer2 me-2"></i>
                    Current Month Status
                </h6>
                <div style="margin-bottom: 0.75rem;">
                    <div style="font-size: 0.85rem; color: #999; margin-bottom: 0.25rem;">${budgetData.current_month}</div>
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-${icon}" style="font-size: 2rem; color: ${color}; margin-right: 0.75rem;"></i>
                        <div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: ${color};">${label}</div>
                            <div style="font-size: 0.85rem; color: #ccc;">
                                Spent: ${budgetData.current_spending.toLocaleString()}${CURRENCY_SYMBOL}
                            </div>
                        </div>
                    </div>
                    <div style="font-size: 0.75rem; color: #999;">
                        <i class="bi bi-graph-up me-1"></i>
                        Projected: ${budgetData.predicted_month_total.toLocaleString()}${CURRENCY_SYMBOL}
                    </div>
                </div>
            </div>
        `;
    }

    // Recommendation Card
    if (budgetData.success && budgetData.recommendation) {
        html += `
            <div class="prediction-card" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 1rem;">
                <h6 style="color: #ba55d3; margin-bottom: 0.75rem;">
                    <i class="bi bi-lightbulb me-2"></i>
                    AI Recommendation
                </h6>
                <p style="font-size: 0.9rem; color: #ccc; line-height: 1.6; margin: 0;">
                    ${budgetData.recommendation}
                </p>
            </div>
        `;
    }

    html += '</div>';
    contentDiv.innerHTML = html;
}

function refreshPredictiveAnalytics() {
    const contentDiv = document.getElementById('predictive-content');
    contentDiv.innerHTML = `
        <div class="muted">
            <i class="bi bi-hourglass-split me-2"></i>
            Refreshing predictions...
        </div>
    `;
    loadPredictiveAnalytics();
}

// ============================================
// PHASE 15: ANOMALY DETECTION WIDGET
// ============================================

async function loadAnomalyDetection() {
    const contentDiv = document.getElementById('anomaly-content');

    try {
        // Fetch anomaly insights
        const response = await fetch('/ai/anomalies/insights');
        const data = await response.json();

        if (data.success && (data.insights.length > 0 || data.recommendations.length > 0)) {
            displayAnomalies(data);
        } else {
            contentDiv.innerHTML = `
                <div class="alert alert-success" style="background: rgba(40, 167, 69, 0.1); border: 1px solid rgba(40, 167, 69, 0.3);">
                    <i class="bi bi-check-circle me-2"></i>
                    No unusual spending patterns detected. Your finances look healthy!
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading anomalies:', error);
        contentDiv.innerHTML = `
            <div class="alert alert-danger" style="background: rgba(220, 53, 69, 0.1); border: 1px solid rgba(220, 53, 69, 0.3);">
                <i class="bi bi-x-circle me-2"></i>
                Failed to load anomaly detection. Please try again later.
            </div>
        `;
    }
}

function displayAnomalies(data) {
    const contentDiv = document.getElementById('anomaly-content');

    let html = '<div class="anomalies-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">';

    // Insights Card
    if (data.insights && data.insights.length > 0) {
        html += `
            <div class="anomaly-card" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 1rem;">
                <h6 style="color: #ff6347; margin-bottom: 0.75rem;">
                    <i class="bi bi-info-circle me-2"></i>
                    Key Findings
                </h6>
                <div style="font-size: 0.9rem; color: #ccc; line-height: 1.8;">
        `;

        data.insights.forEach((insight, idx) => {
            html += `
                <div class="mb-2">
                    <i class="bi bi-dot" style="color: #ff6347;"></i>
                    ${insight}
                </div>
            `;
        });

        html += `
                </div>
            </div>
        `;
    }

    // Recommendations Card
    if (data.recommendations && data.recommendations.length > 0) {
        html += `
            <div class="anomaly-card" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 1rem;">
                <h6 style="color: #ff6347; margin-bottom: 0.75rem;">
                    <i class="bi bi-clipboard-check me-2"></i>
                    Action Items
                </h6>
                <div style="font-size: 0.9rem; color: #ccc; line-height: 1.8;">
        `;

        data.recommendations.forEach((rec, idx) => {
            html += `
                <div class="mb-2">
                    <i class="bi bi-arrow-right-circle" style="color: #fbbf24;"></i>
                    ${rec}
                </div>
            `;
        });

        html += `
                </div>
            </div>
        `;
    }

    // Detailed Anomalous Transactions List (if available)
    if (data.detailed_anomalies && data.detailed_anomalies.general &&
        data.detailed_anomalies.general.anomalies &&
        data.detailed_anomalies.general.anomalies.length > 0) {

        const anomalies = data.detailed_anomalies.general.anomalies;
        const anomalyCount = anomalies.length;
        const highSeverity = anomalies.filter(a => a.severity === 'high').length;

        // Show top 5 most severe anomalies
        const topAnomalies = anomalies.slice(0, 5);

        html += `
            <div class="anomaly-card" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 1rem; grid-column: 1 / -1;">
                <h6 style="color: #ff6347; margin-bottom: 0.75rem;">
                    <i class="bi bi-list-ul me-2"></i>
                    Unusual Transactions
                    ${highSeverity > 0 ? `<span style="background: rgba(255, 99, 71, 0.2); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">${highSeverity} high priority</span>` : ''}
                </h6>
                <div style="font-size: 0.85rem; color: #999; margin-bottom: 1rem;">
                    Showing ${Math.min(5, anomalyCount)} of ${anomalyCount} unusual transaction${anomalyCount > 1 ? 's' : ''}
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
        `;

        topAnomalies.forEach((anomaly, idx) => {
            const severityColors = {
                'high': '#fca5a5',
                'medium': '#fbbf24',
                'low': '#93c5fd'
            };
            const severityIcons = {
                'high': 'exclamation-circle-fill',
                'medium': 'exclamation-triangle-fill',
                'low': 'info-circle-fill'
            };
            const color = severityColors[anomaly.severity] || '#999';
            const icon = severityIcons[anomaly.severity] || 'info-circle';

            // Format date
            const date = new Date(anomaly.date);
            const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

            html += `
                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 6px; padding: 0.75rem; display: flex; align-items-start; gap: 0.75rem;">
                    <div style="flex-shrink: 0;">
                        <i class="bi bi-${icon}" style="color: ${color}; font-size: 1.25rem;"></i>
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; justify-content-between; align-items-start; margin-bottom: 0.25rem;">
                            <div style="font-weight: 600; color: #fff; font-size: 0.95rem;">
                                ${anomaly.amount.toLocaleString()}${CURRENCY_SYMBOL}
                                <span style="font-weight: 400; color: #999; margin-left: 0.5rem;"> ${anomaly.category}</span>
                            </div>
                            <div style="font-size: 0.8rem; color: #999; white-space: nowrap;">
                                ${formattedDate}
                            </div>
                        </div>
                        ${anomaly.note ? `
                            <div style="font-size: 0.85rem; color: #ccc; margin-bottom: 0.5rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${anomaly.note}
                            </div>
                        ` : ''}
                        <div style="font-size: 0.8rem; color: #aaa; font-style: italic; line-height: 1.4;">
                            <i class="bi bi-info-circle" style="font-size: 0.75rem; margin-right: 0.25rem;"></i>
                            ${anomaly.explanation}
                        </div>
                    </div>
                </div>
            `;
        });

        html += `
                </div>
                ${anomalyCount > 5 ? `
                    <div style="margin-top: 1rem; text-align: center;">
                        <a href="/entries/" class="btn btn-sm" style="background: rgba(255, 99, 71, 0.2); border: 1px solid rgba(255, 99, 71, 0.4); color: #ff6347;">
                            <i class="bi bi-eye me-1"></i>
                            View All ${anomalyCount} Transactions
                        </a>
                    </div>
                ` : ''}
            </div>
        `;
    }

    html += '</div>';
    contentDiv.innerHTML = html;
}

function refreshAnomalies() {
    const contentDiv = document.getElementById('anomaly-content');
    contentDiv.innerHTML = `
        <div class="muted">
            <i class="bi bi-hourglass-split me-2"></i>
            Refreshing anomaly detection...
        </div>
    `;
    loadAnomalyDetection();
}
</script>

{% endblock %}