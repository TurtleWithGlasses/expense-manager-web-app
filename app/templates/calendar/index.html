{% extends "base.html" %}

{% block title %}Calendar - Expense Manager{% endblock %}

{% block content %}
<style>
  /* Ensure summary cards stay in one row */
  .calendar-summary-row {
    display: flex;
    flex-wrap: nowrap;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .calendar-summary-row > div {
    flex: 1;
    min-width: 0;
  }

  /* Responsive: stack on mobile */
  @media (max-width: 768px) {
    .calendar-summary-row {
      flex-wrap: wrap;
    }
  }
</style>
<div class="container-fluid py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
      <i class="bi bi-calendar3"></i> Financial Calendar
    </h1>
  </div>

  <!-- Month Navigation -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row align-items-center">
        <div class="col-md-4">
          <div class="btn-group" role="group">
            <a href="/calendar?year={{ prev_year }}&month={{ prev_month }}"
               class="btn btn-outline-primary">
              <i class="bi bi-chevron-left"></i> Previous
            </a>
            <a href="/calendar" class="btn btn-outline-primary">
              Today
            </a>
            <a href="/calendar?year={{ next_year }}&month={{ next_month }}"
               class="btn btn-outline-primary">
              Next <i class="bi bi-chevron-right"></i>
            </a>
          </div>
        </div>

        <div class="col-md-4 text-center">
          <h2 class="h4 mb-0">{{ calendar_data.month_name }} {{ current_year }}</h2>
        </div>

        <div class="col-md-4 text-end">
          {% if available_months %}
          <select class="form-select d-inline-block w-auto"
                  onchange="window.location.href='/calendar?year=' + this.value.split('-')[0] + '&month=' + this.value.split('-')[1]">
            <option value="">Jump to month...</option>
            {% for month_opt in available_months %}
            <option value="{{ month_opt.year }}-{{ month_opt.month }}"
                    {% if month_opt.year == current_year and month_opt.month == current_month %}selected{% endif %}>
              {{ month_opt.display }}
            </option>
            {% endfor %}
          </select>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Month Summary -->
  <div class="calendar-summary-row">
    <div>
      <div class="summary-card income-card">
        <div class="summary-icon">
          <i class="bi bi-arrow-down-circle"></i>
        </div>
        <div class="summary-content">
          <div class="summary-label">Total Income</div>
          <div class="summary-value">${{ "%.2f"|format(month_summary.total_income) }}</div>
        </div>
      </div>
    </div>

    <div>
      <div class="summary-card expense-card">
        <div class="summary-icon">
          <i class="bi bi-arrow-up-circle"></i>
        </div>
        <div class="summary-content">
          <div class="summary-label">Total Expenses</div>
          <div class="summary-value">${{ "%.2f"|format(month_summary.total_expense) }}</div>
        </div>
      </div>
    </div>

    <div>
      <div class="summary-card net-card">
        <div class="summary-icon">
          <i class="bi bi-graph-up"></i>
        </div>
        <div class="summary-content">
          <div class="summary-label">Net Balance</div>
          <div class="summary-value {% if month_summary.net >= 0 %}positive{% else %}negative{% endif %}">${{ "%.2f"|format(month_summary.net) }}</div>
        </div>
      </div>
    </div>

    <div>
      <div class="summary-card count-card">
        <div class="summary-icon">
          <i class="bi bi-receipt"></i>
        </div>
        <div class="summary-content">
          <div class="summary-label">Transactions</div>
          <div class="summary-value">{{ month_summary.entry_count }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Calendar Grid -->
  <div class="calendar-grid-wrapper">
    {% include "calendar/calendar_grid.html" %}
  </div>

  <!-- Calendar Legend -->
  <div class="calendar-legend">
    <div class="legend-item">
      <div class="legend-marker income-marker"></div>
      <span class="legend-label">Income</span>
    </div>
    <div class="legend-item">
      <div class="legend-marker expense-marker"></div>
      <span class="legend-label">Expenses</span>
    </div>
    <div class="legend-item">
      <div class="legend-marker mixed-marker"></div>
      <span class="legend-label">Mixed (Income & Expenses)</span>
    </div>
    <div class="legend-item">
      <div class="legend-marker bill-marker"></div>
      <span class="legend-label">Bills & Subscriptions Due</span>
    </div>
  </div>
</div>

<!-- Date Detail Modal -->
<div class="modal fade" id="dateDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" id="dateDetailContent">
      <!-- Content loaded via HTMX -->
    </div>
  </div>
</div>

<script>
function showDateDetail(dateStr) {
  // Use HTMX to load date detail
  htmx.ajax('GET', '/calendar/date/' + dateStr, {
    target: '#dateDetailContent',
    swap: 'innerHTML'
  }).then(() => {
    const modal = new bootstrap.Modal(document.getElementById('dateDetailModal'));
    modal.show();
  });
}

// Add keyboard navigation for calendar dates
document.addEventListener('DOMContentLoaded', function() {
  const calendarDates = document.querySelectorAll('.calendar-date.has-entries');

  calendarDates.forEach(dateEl => {
    dateEl.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        const dateStr = this.dataset.date;
        showDateDetail(dateStr);
      }
    });
  });
});
</script>
{% endblock %}
