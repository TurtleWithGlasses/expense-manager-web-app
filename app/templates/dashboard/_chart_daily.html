<div class="chart-container">
    <canvas id="dailyChart"></canvas>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
<script>
// Destroy existing chart if it exists
if (window.dailyChartInstance) {
    window.dailyChartInstance.destroy();
}

// Small delay to ensure canvas is properly rendered
setTimeout(() => {
    const ctx = document.getElementById('dailyChart').getContext('2d');

    // Chart data passed from the backend
    const chartData = {{ chart_data | safe }};
    const userCurrency = '{{ user_currency }}';

    // Create new chart instance
    const chart = new Chart(ctx, {
    type: 'line',
    data: chartData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        plugins: {
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.9)',
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: 'rgba(255, 255, 255, 0.2)',
                borderWidth: 1,
                cornerRadius: 8,
                displayColors: false,
                padding: 12,
                titleFont: {
                    size: 14,
                    weight: 'bold'
                },
                bodyFont: {
                    size: 12
                },
                callbacks: {
                    title: function(context) {
                        const date = new Date(context[0].label);
                        return date.toLocaleDateString('en-US', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });
                    },
                    beforeBody: function(context) {
                        const dataIndex = context[0].dataIndex;
                        const categoryData = chartData.datasets[0].categoryData[dataIndex];
                        
                        if (!categoryData || Object.keys(categoryData).length === 0) {
                            return ['No expenses for this day'];
                        }
                        
                        return ['Category Breakdown:'];
                    },
                    label: function(context) {
                        const dataIndex = context.dataIndex;
                        const categoryData = chartData.datasets[0].categoryData[dataIndex];
                        
                        if (!categoryData || Object.keys(categoryData).length === 0) {
                            return '';
                        }
                        
                        // Create array of category lines
                        const categoryLines = [];
                        
                        // Sort categories by amount (highest first)
                        const sortedCategories = Object.entries(categoryData)
                            .sort(([,a], [,b]) => b - a);
                        
                        for (const [category, amount] of sortedCategories) {
                            categoryLines.push(`  â€¢ ${category}: ${userCurrency}${amount.toFixed(2)}`);
                        }
                        
                        return categoryLines;
                    },
                    afterBody: function(context) {
                        const total = context[0].parsed.y;
                        if (total > 0) {
                            return [
                                '', // Empty line for spacing
                                `Total Daily Expenses: ${userCurrency}${total.toFixed(2)}`
                            ];
                        }
                        return [];
                    }
                }
            },
            legend: {
                display: true,
                labels: {
                    color: '#fff',
                    font: {
                        size: 12
                    }
                }
            }
        },
        scales: {
            x: {
                display: true,
                title: {
                    display: true,
                    text: 'Date',
                    color: '#fff',
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                },
                ticks: {
                    color: '#fff',
                    font: {
                        size: 11
                    },
                    callback: function(value, index, values) {
                        const date = new Date(this.getLabelForValue(value));
                        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }
                },
                grid: {
                    color: 'rgba(255, 255, 255, 0.1)',
                    drawBorder: false
                }
            },
            y: {
                display: true,
                title: {
                    display: true,
                    text: `Amount (${userCurrency})`,
                    color: '#fff',
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                },
                ticks: {
                    color: '#fff',
                    font: {
                        size: 11
                    },
                    callback: function(value) {
                        return userCurrency + value.toFixed(0);
                    }
                },
                grid: {
                    color: 'rgba(255, 255, 255, 0.1)',
                    drawBorder: false
                }
            }
        }
    }
    });

    // Store the chart instance globally for cleanup
    window.dailyChartInstance = chart;
}, 100);
</script>

<style>
.chart-container {
    position: relative;
    height: 400px;
    width: 100%;
    padding: 1rem;
}

#dailyChart {
    background: transparent;
}
</style>