{% extends "base.html" %}

{% block title %}Budget Recommendations - Expense Manager{% endblock %}

{% block content %}
<style>
  /* Dark theme support - ensure dark backgrounds and readable text */
  .card {
    background-color: var(--panel) !important;
    color: var(--text);
  }

  .card-header {
    background-color: var(--surface) !important;
    color: var(--text) !important;
    border-bottom: 1px solid var(--border);
  }

  .card-body {
    background-color: var(--panel) !important;
    color: var(--text);
  }

  /* Override Bootstrap table default white background */
  .recommendations-table tbody tr {
    background-color: transparent !important;
  }
  .recommendations-table tbody td {
    background-color: transparent !important;
    border-color: var(--border) !important;
    color: var(--text);
  }
  .recommendations-table thead th {
    background-color: var(--surface) !important;
    border-color: var(--border) !important;
    color: var(--text);
  }
  .recommendations-table tfoot th {
    background-color: var(--surface) !important;
    border-color: var(--border) !important;
    color: var(--text);
  }

  h1, h2, h3, h4, h5, h6, p, strong {
    color: var(--text);
  }

  .text-muted {
    color: var(--text-secondary) !important;
  }
</style>
<div class="container-fluid py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-2">
          <li class="breadcrumb-item"><a href="/intelligence">Budget Intelligence</a></li>
          <li class="breadcrumb-item active">Budget Recommendations</li>
        </ol>
      </nav>
      <h1 class="h3 mb-0">
        <i class="bi bi-wallet2"></i> Smart Budget Recommendations
      </h1>
    </div>
  </div>

  <!-- Summary Card -->
  <div class="card mb-4 border-primary">
    <div class="card-body" style="color: var(--text);">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h5 class="card-title mb-2" style="color: var(--text);">
            <i class="bi bi-lightbulb-fill text-warning"></i> Your Recommended Monthly Budget
          </h5>
          <p class="mb-0" style="color: var(--text-secondary);">
            Based on {{ analysis_period_days }} days of spending analysis across {{ recommendations|length }} categories
          </p>
        </div>
        <div class="col-md-4 text-end">
          <h2 class="mb-0 text-primary" style="color: var(--primary);">
            {{ format_currency(total_recommended_monthly) }}
          </h2>
          <p class="mb-0" style="color: var(--text-secondary);">per month</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Recommendations List -->
  {% if recommendations %}
  <div class="card">
    <div class="card-header" style="background-color: var(--surface); color: var(--text);">
      <h5 class="mb-0" style="color: var(--text);">Category-by-Category Recommendations</h5>
    </div>
    <div class="table-responsive">
      <table class="table table-hover mb-0 recommendations-table" style="color: var(--text);">
        <thead style="background-color: var(--surface);">
          <tr>
            <th style="color: var(--text);">Category</th>
            <th class="text-end" style="color: var(--text);">Current Average</th>
            <th class="text-end" style="color: var(--text);">Recommended Budget</th>
            <th class="text-center" style="color: var(--text);">Confidence</th>
            <th class="text-end" style="color: var(--text);">Min/Max Spent</th>
            <th style="color: var(--text);">Insight</th>
          </tr>
        </thead>
        <tbody>
          {% for rec in recommendations %}
          <tr style="background-color: transparent;">
            <td style="color: var(--text); border-color: var(--border);">
              <i class="bi bi-tag"></i>
              <strong>{{ rec.category_name }}</strong>
              <br>
              <small style="color: var(--text-secondary);">{{ rec.entry_count }} transactions</small>
            </td>
            <td class="text-end" style="color: var(--text-secondary); border-color: var(--border);">
              <span>{{ format_currency(rec.current_average) }}</span>
            </td>
            <td class="text-end" style="color: var(--text); border-color: var(--border);">
              <strong class="text-primary">{{ format_currency(rec.recommended_budget) }}</strong>
              <br>
              <small class="text-success">
                +{{ "%.1f"|format((rec.recommended_budget - rec.current_average) / rec.current_average * 100) }}% buffer
              </small>
            </td>
            <td class="text-center" style="border-color: var(--border);">
              {% if rec.confidence == 'high' %}
              <span class="badge bg-success">High</span>
              {% elif rec.confidence == 'medium' %}
              <span class="badge bg-warning text-dark">Medium</span>
              {% else %}
              <span class="badge bg-secondary">Low</span>
              {% endif %}
            </td>
            <td class="text-end" style="border-color: var(--border);">
              <small style="color: var(--text-secondary);">
                {{ format_currency(rec.min_spent) }} - {{ format_currency(rec.max_spent) }}
                <br>
                <span class="badge bg-secondary" style="color: var(--text);">
                  {{ "%.0f"|format(rec.variability_percent) }}% variance
                </span>
              </small>
            </td>
            <td style="color: var(--text); border-color: var(--border);">
              <small>
                <i class="bi bi-info-circle text-info"></i>
                {{ rec.description }}
              </small>
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot style="background-color: var(--surface);">
          <tr>
            <th colspan="2" class="text-end" style="color: var(--text);">Total:</th>
            <th class="text-end" style="color: var(--text);">
              <strong class="text-primary fs-5">{{ format_currency(total_recommended_monthly) }}</strong>
            </th>
            <th colspan="3"></th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- Tips Card -->
  <div class="card mt-4">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Budget Tips</h5>
    </div>
    <div class="card-body" style="color: var(--text);">
      <div class="row">
        <div class="col-md-4">
          <h6 style="color: var(--text);"><i class="bi bi-check-circle text-success"></i> Understanding Confidence Levels</h6>
          <ul class="small" style="color: var(--text);">
            <li><strong>High:</strong> Stable spending (&lt;20% variance) - reliable recommendation</li>
            <li><strong>Medium:</strong> Moderate variation (20-50%) - review monthly</li>
            <li><strong>Low:</strong> Highly variable (&gt;50%) - needs closer monitoring</li>
          </ul>
        </div>
        <div class="col-md-4">
          <h6 style="color: var(--text);"><i class="bi bi-calculator text-primary"></i> How We Calculate</h6>
          <ul class="small" style="color: var(--text);">
            <li>Analyze last 3 months of spending per category</li>
            <li>Calculate average monthly amount</li>
            <li>Add 15% safety buffer for unexpected costs</li>
            <li>Consider historical highs and lows</li>
          </ul>
        </div>
        <div class="col-md-4">
          <h6 style="color: var(--text);"><i class="bi bi-graph-up text-success"></i> Taking Action</h6>
          <ul class="small" style="color: var(--text);">
            <li>Set budgets in the Categories page</li>
            <li>Get alerts when approaching limits</li>
            <li>Review and adjust monthly</li>
            <li>Track progress in Dashboard</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  {% else %}
  <!-- No Data -->
  <div class="card">
    <div class="card-body text-center py-5">
      <i class="bi bi-inbox fs-1 text-muted mb-3 d-block"></i>
      <h5>Not Enough Data</h5>
      <p class="text-muted">
        We need at least 3 months of expense data to generate accurate budget recommendations.
        <br>
        Keep tracking your expenses and check back soon!
      </p>
      <a href="/entries" class="btn btn-primary mt-3">
        <i class="bi bi-plus-circle"></i> Add Expenses
      </a>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
