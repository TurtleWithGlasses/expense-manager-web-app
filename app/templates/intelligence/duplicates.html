{% extends "base.html" %}

{% block title %}Duplicate Detection - Expense Manager{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-2">
          <li class="breadcrumb-item"><a href="/intelligence">Budget Intelligence</a></li>
          <li class="breadcrumb-item active">Duplicates</li>
        </ol>
      </nav>
      <h1 class="h3 mb-0">
        <i class="bi bi-files"></i> Duplicate Transaction Detection
      </h1>
    </div>
  </div>

  <!-- Summary -->
  <div class="card mb-4 {% if total_duplicates > 0 %}border-danger{% else %}border-success{% endif %}">
    <div class="card-body" style="color: var(--text);">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          {% if total_duplicates > 0 %}
          <h5 class="text-danger mb-2" style="color: var(--text);">
            <i class="bi bi-exclamation-triangle-fill"></i>
            {{ total_duplicates }} Potential Duplicate Group{{ "s" if total_duplicates != 1 else "" }} Found
          </h5>
          <p class="mb-0" style="color: var(--text-secondary);">
            Review the transactions below to identify and remove duplicates
          </p>
          {% else %}
          <h5 class="text-success mb-2" style="color: var(--text);">
            <i class="bi bi-check-circle-fill"></i>
            No Duplicates Detected
          </h5>
          <p class="mb-0" style="color: var(--text-secondary);">
            All your transactions appear to be unique. Great job keeping your records clean!
          </p>
          {% endif %}
        </div>
        <div>
          <span class="badge bg-secondary fs-6">
            Last {{ days_analyzed }} days analyzed
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Duplicates List -->
  {% if duplicates %}
  {% for dup in duplicates %}
  <div class="card mb-3 border-warning">
    <div class="card-header bg-warning bg-opacity-10">
      <div class="d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
          <i class="bi bi-files"></i>
          Duplicate Group #{{ loop.index }}
          <span class="badge bg-warning text-dark ms-2">{{ dup.count }} transactions</span>
          <span class="badge bg-{{ 'danger' if dup.confidence == 'high' else 'secondary' }} ms-1">
            {{ dup.confidence|capitalize }} Confidence
          </span>
        </h6>
        <div>
          <strong class="text-danger">
            Total: {{ format_currency(dup.total_amount) }}
          </strong>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <thead>
            <tr>
              <th>ID</th>
              <th>Date</th>
              <th>Category</th>
              <th class="text-end">Amount</th>
              <th>Type</th>
              <th>Notes</th>
              <th class="text-center">Action</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in dup.entries %}
            <tr>
              <td><code>#{{ entry.id }}</code></td>
              <td>{{ entry.date }}</td>
              <td>
                <span class="badge bg-light text-dark">{{ entry.category }}</span>
              </td>
              <td class="text-end">
                <strong>{{ format_currency(entry.amount) }}</strong>
              </td>
              <td>
                <span class="badge bg-{{ 'success' if entry.type == 'income' else 'danger' }}">
                  {{ entry.type|capitalize }}
                </span>
              </td>
              <td>
                <small>{{ entry.notes or '-' }}</small>
              </td>
              <td class="text-center">
                <a href="/entries?highlight={{ entry.id }}"
                   class="btn btn-sm btn-outline-primary"
                   target="_blank">
                  <i class="bi bi-eye"></i> View
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="mt-3 p-3 bg-light rounded">
        <p class="mb-2">
          <strong><i class="bi bi-lightbulb text-warning"></i> Suggested Action:</strong>
        </p>
        <ul class="mb-0 small">
          {% if dup.confidence == 'high' %}
          <li>These entries are very likely duplicates (same amount, category, date, and notes)</li>
          <li>Review them carefully and delete all but one if they represent the same transaction</li>
          {% else %}
          <li>These entries might be duplicates (similar amount, category, and nearby dates)</li>
          <li>They could be legitimate separate transactions - review the notes and dates carefully</li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>
  {% endfor %}

  <!-- Tips -->
  <div class="card mt-4">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0"><i class="bi bi-info-circle"></i> How to Handle Duplicates</h5>
    </div>
    <div class="card-body" style="color: var(--text);">
      <div class="row">
        <div class="col-md-6">
          <h6 style="color: var(--text);">Detection Criteria</h6>
          <p class="small" style="color: var(--text);">We identify potential duplicates based on:</p>
          <ul class="small" style="color: var(--text);">
            <li>Same or very similar amounts</li>
            <li>Same category</li>
            <li>Same entry type (income/expense)</li>
            <li>Dates within 2 days of each other</li>
            <li>Similar or identical notes</li>
          </ul>
        </div>
        <div class="col-md-6">
          <h6 style="color: var(--text);">What to Do</h6>
          <ol class="small" style="color: var(--text);">
            <li>Click "View" to see each transaction in detail</li>
            <li>Compare the notes, dates, and amounts carefully</li>
            <li>If they're truly duplicates, keep one and delete the others</li>
            <li>If they're separate transactions, no action needed</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  {% else %}
  <div class="card">
    <div class="card-body text-center py-5">
      <i class="bi bi-check-circle fs-1 text-success mb-3 d-block"></i>
      <h5>No Duplicates Found</h5>
      <p class="text-muted">
        Your last {{ days_analyzed }} days of transactions look clean with no apparent duplicates.
      </p>
      <a href="/entries" class="btn btn-primary mt-3">
        <i class="bi bi-list-ul"></i> View All Entries
      </a>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
