{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h1 mb-0">Entries</h1>
    <div class="d-flex gap-2">
        <a href="/categories" class="btn btn-outline-primary">
            <i class="bi bi-tags me-1"></i>
            Manage Categories
        </a>
    </div>
</div>

<!-- Date Filter Section -->
<div class="card mb-4">
    <div class="card-body">
        <h6 class="card-title mb-3">
            <i class="bi bi-calendar-range me-2"></i>
            Filter by Date Range
        </h6>
        <form method="GET" action="/entries" class="row g-3 align-items-end">
            <div class="col-md-3 col-12">
                <label for="start_date" class="form-label">Start Date</label>
                <input type="date" 
                       class="form-control" 
                       id="start_date" 
                       name="start" 
                       value="{{ start_date or '' }}">
            </div>
            <div class="col-md-3 col-12">
                <label for="end_date" class="form-label">End Date</label>
                <input type="date" 
                       class="form-control" 
                       id="end_date" 
                       name="end" 
                       value="{{ end_date or '' }}">
            </div>
            <div class="col-md-3 col-12">
                <label for="category_filter" class="form-label">Category</label>
                <select class="form-control" 
                        id="category_filter" 
                        name="category">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}" {% if selected_category and selected_category == category.id|string %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12">
                <div class="d-flex gap-2 flex-wrap align-items-center">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search me-1"></i>
                        Filter
                    </button>
                    <a href="/entries" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle me-1"></i>
                        Clear
                    </a>
                    <button type="button" class="btn btn-outline-success" onclick="exportToExcel()" title="Export to Excel">
                        <i class="bi bi-file-earmark-excel me-1"></i>
                        Excel Report
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="exportToPDF()" title="Export to PDF">
                        <i class="bi bi-file-earmark-pdf me-1"></i>
                        PDF Report
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="openBulkAIModal()" title="Bulk AI Categorization">
                        <i class="bi bi-robot me-1"></i>
                        AI Categorize
                    </button>
                </div>
            </div>
        </form>
        {% if start_date and end_date or selected_category %}
        <div class="mt-3">
            <small class="text-light" style="opacity: 0.8;">
                <i class="bi bi-info-circle me-1"></i>
                {% if start_date and end_date %}
                    Showing entries from {{ start_date }} to {{ end_date }}
                {% endif %}
                {% if selected_category %}
                    {% for category in categories %}
                        {% if category.id|string == selected_category %}
                            {% if start_date and end_date %} - {% endif %}in category "{{ category.name }}"
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </small>
        </div>
        {% endif %}
    </div>
</div>

<!-- Improved Add form with better styling -->
<div class="card bg-gradient mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
  <div class="card-body">
    <h5 class="text-white mb-3">Add New Entry</h5>
    <form
      id="entry-add-form"
      class="row g-3 align-items-end"
      hx-post="/entries/create"
      hx-target="#entries-tbody"
      hx-swap="innerHTML"
      hx-disabled-elt="button">
      
      <!-- Hidden field to pass user currency -->
      <input type="hidden" name="currency_code" value="{{ user_currency }}">

      <!-- Type -->
      <div class="col-12 col-md-2">
        <label class="form-label text-white-50 small">Type</label>
        <select name="type" class="form-select form-select-lg shadow-sm" required>
          <option value="expense">Expense</option>
          <option value="income">Income</option>
        </select>
      </div>

      <!-- Amount -->
      <div class="col-12 col-md-2">
        <label class="form-label text-white-50 small">Amount ({{ user_currency }})</label>
        <input name="amount" type="number" step="0.01" 
               class="form-control form-control-lg shadow-sm" 
               placeholder="0.00" required>
      </div>

      <!-- Category -->
      <div class="col-12 col-md-3">
        <label class="form-label text-white-50 small">Category</label>
        <select name="category_id" class="form-select form-select-lg shadow-sm">
          <option value="">(No category)</option>
          {% for c in categories %}
            <option value="{{ c.id }}">{{ c.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Date -->
      <div class="col-12 col-md-2">
        <label class="form-label text-white-50 small">Date</label>
        <input name="date_str" type="date" 
               class="form-control form-control-lg shadow-sm" 
               value="{{ today }}" required>
      </div>

      <!-- Note & submit -->
      <div class="col-12 col-md-3">
        <label class="form-label text-white-50 small">Note</label>
        <div class="d-flex gap-2">
          <input name="note" type="text" 
                 class="form-control form-control-lg shadow-sm" 
                 placeholder="Optional note"
                 id="entry-note"
                 oninput="getAISuggestion()">
          <button type="submit" class="btn btn-success btn-lg shadow">
            <i class="bi bi-plus-circle"></i> Add
          </button>
        </div>
        
        <!-- AI Suggestion Display -->
        <div id="ai-suggestion" class="mt-2" style="display: none;">
          <div class="alert alert-info mb-2" style="background: linear-gradient(135deg, rgba(13, 110, 253, 0.1) 0%, rgba(111, 66, 193, 0.1) 100%); border: 1px solid rgba(13, 110, 253, 0.3); border-radius: 8px; padding: 0.75rem;">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-robot" style="font-size: 1.1rem; color: #0d6efd; flex-shrink: 0;"></i>
              <div class="flex-grow-1" style="min-width: 0;">
                <small class="fw-bold d-block mb-1" style="color: #0d6efd;">AI Suggestion</small>
                <div id="suggestion-text" class="mb-2" style="font-size: 0.9rem;"></div>
                <!-- Confidence Progress Bar -->
                <div class="mb-0">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <small class="text-muted" style="font-size: 0.75rem;">Confidence:</small>
                    <small id="confidence-percentage" class="fw-bold" style="font-size: 0.75rem;"></small>
                  </div>
                  <div class="progress" style="height: 5px; background: rgba(0,0,0,0.1);">
                    <div id="confidence-bar" class="progress-bar" role="progressbar" style="width: 0%; transition: width 0.3s ease;"></div>
                  </div>
                </div>
              </div>
              <div class="d-flex gap-1" style="flex-shrink: 0;">
                <button type="button" class="btn btn-sm btn-success" onclick="acceptAISuggestion()" title="Accept suggestion" style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;">
                  <i class="bi bi-check-lg" style="font-size: 0.9rem;"></i>
                </button>
                <button type="button" class="btn btn-sm btn-danger" onclick="rejectAISuggestion()" title="Reject suggestion" style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;">
                  <i class="bi bi-x-lg" style="font-size: 0.9rem;"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <small class="htmx-indicator text-white-50">Savingâ€¦</small>
      </div>
    </form>
  </div>
</div>

<!-- Sorting and Pagination Controls -->
<div class="card mb-3">
  <div class="card-body py-2">
    <div class="row align-items-center">
      <div class="col-md-6 col-12 mb-2 mb-md-0">
        <small id="entries-summary-text" class="text-light" style="opacity: 0.9;">
          <i class="bi bi-list-ul me-1"></i>
          Showing {{ showing_from }} to {{ showing_to }} of {{ total_count }} entries
        </small>
      </div>
      <div class="col-md-6 col-12">
        <form method="GET" action="/entries" class="d-flex gap-2 justify-content-md-end" id="sortingForm">
          <!-- Preserve filter parameters -->
          {% if start_date %}<input type="hidden" name="start" value="{{ start_date }}">{% endif %}
          {% if end_date %}<input type="hidden" name="end" value="{{ end_date }}">{% endif %}
          {% if selected_category %}<input type="hidden" name="category" value="{{ selected_category }}">{% endif %}
          <input type="hidden" name="offset" value="{{ offset }}">
          <input type="hidden" name="limit" value="{{ limit }}">

          <select class="form-select form-select-sm" name="sort_by" style="width: auto;" onchange="this.form.submit()">
            <option value="date" {% if sort_by == 'date' %}selected{% endif %}>Sort by: Date</option>
            <option value="amount" {% if sort_by == 'amount' %}selected{% endif %}>Sort by: Amount</option>
            <option value="category" {% if sort_by == 'category' %}selected{% endif %}>Sort by: Category</option>
          </select>

          <select class="form-select form-select-sm" name="order" style="width: auto;" onchange="this.form.submit()">
            <option value="desc" {% if order == 'desc' %}selected{% endif %}>
              {% if sort_by == 'date' %}Newest First
              {% elif sort_by == 'amount' %}Highest First
              {% else %}Z-A{% endif %}
            </option>
            <option value="asc" {% if order == 'asc' %}selected{% endif %}>
              {% if sort_by == 'date' %}Oldest First
              {% elif sort_by == 'amount' %}Lowest First
              {% else %}A-Z{% endif %}
            </option>
          </select>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Desktop Table - Hidden on Mobile -->
<div class="card shadow d-none d-md-block">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-dark table-hover table-borderless align-middle mb-0">
        <thead class="table-secondary">
          <tr>
            <th style="width:14%">Date</th>
            <th style="width:14%">Type</th>
            <th style="width:14%">Amount</th>
            <th style="width:18%">Category</th>
            <th>Note</th>
            <th class="text-end" style="width:18%">Actions</th>
          </tr>
        </thead>
        <tbody id="entries-tbody">
          {% include "entries/_list.html" %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Load More Button -->
{% if has_more %}
<div class="text-center my-4" id="load-more-container">
  <button onclick="loadMoreEntries()" class="btn btn-primary btn-lg" id="load-more-btn">
    <i class="bi bi-arrow-down-circle me-2"></i>
    Load More Entries
    <span class="badge bg-light text-dark ms-2" id="remaining-count">{{ total_count - showing_to }} remaining</span>
  </button>
  <div id="load-more-loading" style="display: none;" class="mt-2">
    <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <span class="text-light">Loading more entries...</span>
  </div>
</div>
{% endif %}

<!-- Mobile Card Layout - Hidden on Desktop -->
<div class="d-md-none" id="mobile-entries">
  <div id="mobile-entries-list">
    {% include "entries/_mobile_list.html" %}
  </div>

  <!-- Load More Button for Mobile -->
  {% if has_more %}
  <div class="text-center my-4" id="load-more-mobile-container">
    <button onclick="loadMoreMobileEntries()" class="btn btn-primary btn-lg w-100" id="load-more-mobile-btn">
      <i class="bi bi-arrow-down-circle me-2"></i>
      Load More Entries
      <span class="badge bg-light text-dark ms-2" id="remaining-count-mobile">{{ total_count - showing_to }} remaining</span>
    </button>
    <div id="load-more-mobile-loading" style="display: none;" class="mt-2">
      <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <span class="text-light">Loading more entries...</span>
    </div>
  </div>
  {% endif %}
</div>

<!-- Add custom styles -->
<style>
  /* Date filter styling */
  .card {
    background: var(--panel);
    border: 1px solid #1c2440;
    border-radius: 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
  }
  
  .card-title {
    color: #ffffff;
    font-weight: 600;
  }
  
  .form-label {
    color: #ffffff;
    font-weight: 500;
    font-size: 0.875rem;
  }
  
  
  .form-control::placeholder {
    color: #cbd5e1;
  }
  
  /* Date input specific styling */
  input[type="date"] {
    color: #374151 !important;
    background: rgba(255, 255, 255, 0.95) !important;
    border: 2px solid transparent !important;
  }
  
  input[type="date"]:focus {
    color: #374151 !important;
    background: white !important;
    border-color: #667eea !important;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
  }
  
  input[type="date"]:hover {
    color: #374151 !important;
    background: white !important;
    border-color: #667eea !important;
  }
  
  /* Date input calendar icon styling */
  input[type="date"]::-webkit-calendar-picker-indicator {
    filter: none;
    cursor: pointer;
  }
  
  /* Firefox date input styling */
  input[type="date"]::-moz-datetime-edit-text {
    color: #374151 !important;
  }
  
  input[type="date"]::-moz-datetime-edit-month-field,
  input[type="date"]::-moz-datetime-edit-day-field,
  input[type="date"]::-moz-datetime-edit-year-field {
    color: #374151 !important;
  }
  
  /* Additional date input styling for better cross-browser support */
  input[type="date"]::-webkit-datetime-edit-text {
    color: #374151 !important;
  }
  
  input[type="date"]::-webkit-datetime-edit-month-field,
  input[type="date"]::-webkit-datetime-edit-day-field,
  input[type="date"]::-webkit-datetime-edit-year-field {
    color: #374151 !important;
  }
  
  /* Ensure date input text is always visible */
  input[type="date"] {
    -webkit-text-fill-color: #374151 !important;
    -webkit-opacity: 1 !important;
    opacity: 1 !important;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    font-weight: 600;
  }
  
  .btn-primary:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
  }
  
  .btn-outline-primary {
    border-color: #667eea;
    color: #667eea;
  }
  
  .btn-outline-primary:hover {
    background: #667eea;
    border-color: #667eea;
    color: white;
  }
  
  .btn-outline-secondary {
    border-color: #6b7280;
    color: #6b7280;
  }
  
  .btn-outline-secondary:hover {
    background: #6b7280;
    border-color: #6b7280;
    color: white;
  }

  /* Form improvements */
  .bg-gradient {
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }
  
  .form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
  }
  
  .form-control, .form-select {
    background-color: rgba(255, 255, 255, 0.95);
    border: 2px solid transparent;
    transition: all 0.3s ease;
    color: #374151 !important;
  }
  
  .form-control:hover, .form-select:hover {
    background-color: white;
    border-color: #667eea;
    color: #374151 !important;
  }
  
  .form-control:focus, .form-select:focus {
    background-color: white;
    border-color: #667eea;
    color: #374151 !important;
  }

  /* Table text improvements for better readability */
  .table-dark td {
    color: #e2e8f0 !important;
  }
  
  .table-dark .text-body {
    color: #e2e8f0 !important;
  }
  
  .table-dark .text-secondary {
    color: #9ca3af !important;
  }
  
  /* Expense/Income color coding */
  .expense-type {
    color: #ef4444 !important;
    font-weight: 500;
  }
  
  .income-type {
    color: #10b981 !important;
    font-weight: 500;
  }
  
  .expense-amount {
    color: #fca5a5 !important;
  }
  
  .income-amount {
    color: #86efac !important;
  }

  /* Badge styles for type */
  .type-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 600;
    display: inline-block;
  }
  
  .type-badge.expense {
    background-color: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.2);
  }
  
  .type-badge.income {
    background-color: rgba(16, 185, 129, 0.1);
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.2);
  }

  /* Button improvements */
  .btn-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border: none;
  }
  
  .btn-success:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
  }

  /* Edit row styling */
  .bg-dark-subtle {
    background-color: rgba(255, 255, 255, 0.05) !important;
  }
  
  .bg-dark-subtle .edit-input,
  .bg-dark-subtle .edit-select {
    background-color: rgba(255, 255, 255, 0.1) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    color: #e2e8f0 !important;
    width: 100% !important;
    min-width: 0 !important;
  }
  
  .bg-dark-subtle .edit-input:focus,
  .bg-dark-subtle .edit-select:focus {
    background-color: rgba(255, 255, 255, 0.15) !important;
    border-color: #10b981 !important;
    box-shadow: 0 0 0 0.2rem rgba(16, 185, 129, 0.25) !important;
    color: #e2e8f0 !important;
  }
  
  .bg-dark-subtle .edit-input::placeholder {
    color: #9ca3af !important;
  }
  
  /* Fix dropdown options styling - this won't work in most browsers */
  /* We need to use a different approach for dropdown styling */
  .bg-dark-subtle .edit-select {
    background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='%23e2e8f0' d='m4.427 9.427 3.396 3.396a.25.25 0 0 0 .354 0l3.396-3.396A.25.25 0 0 0 11.396 9H4.604a.25.25 0 0 0-.177.427Z'/%3E%3C/svg%3E") !important;
    background-repeat: no-repeat !important;
    background-position: right 0.75rem center !important;
    background-size: 16px 12px !important;
  }
  
  /* Fix for when dropdown is active/opened */
  .bg-dark-subtle .edit-select:active,
  .bg-dark-subtle .edit-select:focus {
    background-color: rgba(255, 255, 255, 0.15) !important;
    color: #e2e8f0 !important;
  }
  
  /* Table cell padding for edit rows */
  .bg-dark-subtle td {
    padding: 8px !important;
    vertical-align: middle !important;
  }
  
  /* Button spacing in edit row */
  .bg-dark-subtle .btn {
    margin: 0 2px;
  }
  
  /* Additional dropdown fixes for better consistency */
  .bg-dark-subtle .edit-select {
    appearance: none !important;
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
  }
  
  /* Ensure dropdown doesn't turn white on any interaction */
  .bg-dark-subtle .edit-select:hover,
  .bg-dark-subtle .edit-select:active,
  .bg-dark-subtle .edit-select:visited {
    background-color: rgba(255, 255, 255, 0.1) !important;
    color: #e2e8f0 !important;
  }
  
  /* Fix for dropdown arrow */
  .bg-dark-subtle .edit-select::after {
    color: #e2e8f0 !important;
  }
  
  /* Ensure form elements don't overflow their containers */
  .bg-dark-subtle .edit-input,
  .bg-dark-subtle .edit-select {
    max-width: 100% !important;
    box-sizing: border-box !important;
  }
  
  /* Edit form layout improvements */
  .bg-dark-subtle form {
    width: 100% !important;
    margin: 0 !important;
  }
  
  .bg-dark-subtle form > div {
    flex-shrink: 0 !important;
  }
  
  /* Better spacing for edit form */
  .bg-dark-subtle .py-2 {
    padding-top: 0.5rem !important;
    padding-bottom: 0.5rem !important;
  }
  
  .bg-dark-subtle .px-3 {
    padding-left: 1rem !important;
    padding-right: 1rem !important;
  }
  
  /* Ensure dropdown doesn't turn white on any state */
  .bg-dark-subtle .edit-select,
  .bg-dark-subtle .edit-select:focus,
  .bg-dark-subtle .edit-select:active,
  .bg-dark-subtle .edit-select:hover {
    background-color: rgba(255, 255, 255, 0.1) !important;
    color: #e2e8f0 !important;
    border-color: rgba(255, 255, 255, 0.2) !important;
  }

  /* Force dark theme for all form elements */
  .bg-dark-subtle input,
  .bg-dark-subtle select {
    background-color: rgba(255, 255, 255, 0.1) !important;
    color: #e2e8f0 !important;
    border-color: rgba(255, 255, 255, 0.2) !important;
  }

  .bg-dark-subtle input:focus,
  .bg-dark-subtle select:focus {
    background-color: rgba(255, 255, 255, 0.15) !important;
    color: #e2e8f0 !important;
    border-color: #10b981 !important;
    box-shadow: 0 0 0 0.2rem rgba(16, 185, 129, 0.25) !important;
  }

  /* =============================================
     LIGHT THEME OVERRIDES
     ============================================= */
  [data-theme="light"] .card {
    background: #ffffff;
    border: 1px solid #dee2e6;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }

  [data-theme="light"] .card-title {
    color: #212529;
  }

  [data-theme="light"] .form-label {
    color: #495057;
  }

  [data-theme="light"] .text-light,
  [data-theme="light"] .small.text-light {
    color: #6c757d !important;
  }

  [data-theme="light"] .text-white-50 {
    color: #6c757d !important;
  }

  [data-theme="light"] .btn-outline-primary {
    border-color: #0d6efd;
    color: #0d6efd;
  }

  [data-theme="light"] .btn-outline-primary:hover {
    background: #0d6efd;
    color: white;
  }

  [data-theme="light"] .btn-outline-secondary {
    border-color: #6c757d;
    color: #ffffff;
    background: #6c757d;
  }

  [data-theme="light"] .btn-outline-secondary:hover {
    background: #5a6268;
    border-color: #5a6268;
    color: white;
  }

  /* Export buttons styling */
  [data-theme="light"] .btn-outline-success {
    background: #198754;
    border-color: #198754;
    color: #ffffff !important;
  }

  [data-theme="light"] .btn-outline-success:hover {
    background: #157347;
    border-color: #157347;
    color: #ffffff !important;
  }

  [data-theme="light"] .btn-outline-danger {
    background: #dc3545;
    border-color: #dc3545;
    color: #ffffff !important;
  }

  [data-theme="light"] .btn-outline-danger:hover {
    background: #bb2d3b;
    border-color: #bb2d3b;
    color: #ffffff !important;
  }

  /* Edit buttons in table */
  [data-theme="light"] .btn-sm.btn-outline-primary {
    background: #0d6efd;
    border-color: #0d6efd;
    color: #ffffff !important;
  }

  [data-theme="light"] .btn-sm.btn-outline-primary:hover {
    background: #0b5ed7;
    border-color: #0b5ed7;
    color: #ffffff !important;
  }

  [data-theme="light"] .btn-sm.btn-outline-danger {
    background: #dc3545;
    border-color: #dc3545;
    color: #ffffff !important;
  }

  [data-theme="light"] .btn-sm.btn-outline-danger:hover {
    background: #bb2d3b;
    border-color: #bb2d3b;
    color: #ffffff !important;
  }

  /* Quick filter buttons alignment and styling */
  .d-flex.gap-2.flex-wrap {
    align-items: center;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 38px;
    line-height: 1;
    padding: 8px 16px;
  }

  .btn-primary,
  .btn-outline-secondary,
  .btn-outline-success,
  .btn-outline-danger {
    height: 38px;
    min-height: 38px;
  }

  /* Fix action buttons in table - keep them horizontal */
  .table td.text-end {
    white-space: nowrap;
    min-width: 180px;
  }

  .table .btn-sm {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 6px 12px;
    height: auto;
    min-height: 32px;
    font-size: 0.875rem;
    white-space: nowrap;
  }

  /* Ensure buttons stay on same line */
  .table .btn-sm.me-2 {
    margin-right: 8px !important;
  }

  /* Filter section button container */
  .col-md-3.col-12 .d-flex {
    align-items: stretch;
  }

  .col-md-3.col-12 .btn {
    flex: 0 0 auto;
  }

  /* Table light theme fixes */
  [data-theme="light"] .table-dark {
    background: #f8f9fa !important;
  }

  [data-theme="light"] .table-dark thead {
    background: #e9ecef !important;
  }

  [data-theme="light"] .table-dark th {
    color: #848a90 !important;
    background: #e9ecef !important;
  }

  [data-theme="light"] .table-dark td {
    color: #737a81 !important;
    background: #ffffff !important;
  }

  [data-theme="light"] .table-dark tbody tr {
    background: #ffffff !important;
  }

  [data-theme="light"] .table-dark tbody tr:hover,
  [data-theme="light"] .table-hover tbody tr:hover,
  [data-theme="light"] .table-dark.table-hover tbody tr:hover,
  [data-theme="light"] table.table-dark tbody tr:hover {
    background-color: #e9ecef !important;
    background: #e9ecef !important;
  }

  /* Override Bootstrap's dark hover styles */
  [data-theme="light"] .table-dark tbody tr:hover td {
    background-color: #e9ecef !important;
  }

  [data-theme="light"] .table-secondary {
    background: #e9ecef !important;
  }

  /* Add New Entry section light theme */
  [data-theme="light"] .bg-gradient {
    background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%) !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }

  [data-theme="light"] .bg-gradient h5 {
    color: #1a237e !important;
  }

  [data-theme="light"] .bg-gradient .form-label {
    color: #495057 !important;
  }

  [data-theme="light"] .bg-gradient .text-white {
    color: #1a237e !important;
  }

  [data-theme="light"] .bg-gradient .text-white-50 {
    color: #495057 !important;
  }

  /* =============================================
     AI SUGGESTION STYLING
     ============================================= */
  #ai-suggestion {
    animation: slideDown 0.3s ease;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  #ai-suggestion .btn-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    border: none;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
  }

  #ai-suggestion .btn-success:hover {
    background: linear-gradient(135deg, #218838 0%, #1aa179 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
  }

  #ai-suggestion .btn-danger {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    border: none;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2);
  }

  #ai-suggestion .btn-danger:hover {
    background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
  }

  #ai-suggestion .btn-success i,
  #ai-suggestion .btn-danger i {
    font-size: 1rem;
    line-height: 1;
  }

  /* Progress bar animations */
  #confidence-bar {
    animation: fillBar 0.5s ease;
  }

  @keyframes fillBar {
    from {
      width: 0%;
    }
  }

  /* Light theme AI suggestion overrides */
  [data-theme="light"] #ai-suggestion .alert {
    background: linear-gradient(135deg, rgba(13, 110, 253, 0.05) 0%, rgba(111, 66, 193, 0.05) 100%) !important;
    border: 1px solid rgba(13, 110, 253, 0.2) !important;
  }

  [data-theme="light"] #ai-suggestion .bi-robot {
    color: #0d6efd !important;
  }

  [data-theme="light"] #ai-suggestion .fw-bold {
    color: #0d6efd !important;
  }

  [data-theme="light"] #ai-suggestion .text-muted {
    color: #6c757d !important;
  }

  /* Mobile responsive AI suggestions */
  @media (max-width: 768px) {
    #ai-suggestion {
      margin-top: 0.75rem !important;
    }

    #ai-suggestion .alert {
      padding: 0.65rem !important;
    }

    #ai-suggestion .bi-robot {
      font-size: 1rem !important;
    }

    #suggestion-text {
      font-size: 0.85rem !important;
    }

    #confidence-percentage,
    #ai-suggestion .text-muted {
      font-size: 0.7rem !important;
    }

    #ai-suggestion .btn-sm {
      width: 30px !important;
      height: 30px !important;
    }

    #ai-suggestion .btn-sm i {
      font-size: 0.85rem !important;
    }
  }

  @media (max-width: 480px) {
    #ai-suggestion .alert {
      padding: 0.5rem !important;
    }

    #ai-suggestion .d-flex.align-items-center {
      flex-wrap: wrap;
    }

    #ai-suggestion .flex-grow-1 {
      flex-basis: 100%;
      margin-bottom: 0.5rem;
    }

    #ai-suggestion .bi-robot {
      font-size: 0.9rem !important;
    }

    #ai-suggestion .btn-sm {
      width: 36px !important;
      height: 36px !important;
      flex: 0 0 auto;
    }

    #ai-suggestion .btn-sm i {
      font-size: 0.9rem !important;
    }
  }

  /* =============================================
     BULK AI MODAL LIGHT THEME
     ============================================= */
  [data-theme="light"] #bulkAIModal .modal-content {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
    border: 1px solid rgba(13, 110, 253, 0.3) !important;
  }

  [data-theme="light"] #bulkAIModal .modal-header {
    border-bottom: 1px solid #dee2e6 !important;
  }

  [data-theme="light"] #bulkAIModal .modal-footer {
    border-top: 1px solid #dee2e6 !important;
  }

  [data-theme="light"] #bulkAIModal .modal-title {
    color: #0d6efd !important;
  }

  [data-theme="light"] #bulkAIModal .form-label,
  [data-theme="light"] #bulkAIModal .form-check-label {
    color: #212529 !important;
  }

  [data-theme="light"] #bulkAIModal .text-light {
    color: #495057 !important;
  }

  [data-theme="light"] #bulkAIModal .text-muted {
    color: #6c757d !important;
  }

  [data-theme="light"] #bulkAIModal .alert-info {
    background: rgba(13, 110, 253, 0.1) !important;
    border: 1px solid rgba(13, 110, 253, 0.3) !important;
    color: #004085 !important;
  }

  [data-theme="light"] #bulkAIModal .alert-success {
    background: rgba(25, 135, 84, 0.1) !important;
    border: 1px solid rgba(25, 135, 84, 0.3) !important;
    color: #0f5132 !important;
  }

  [data-theme="light"] #bulkAIModal .progress {
    background: #e9ecef !important;
  }
</style>

<script>
let currentSuggestion = null;
let suggestionTimeout = null;

function getAISuggestion() {
    const note = document.getElementById('entry-note').value.trim();
    const amount = document.querySelector('input[name="amount"]').value;
    const type = document.querySelector('select[name="type"]').value;
    
    // Clear previous timeout
    if (suggestionTimeout) {
        clearTimeout(suggestionTimeout);
    }
    
    // Only get suggestion if note has at least 3 characters
    if (note.length < 3) {
        dismissAISuggestion();
        return;
    }
    
    // Debounce the request
    suggestionTimeout = setTimeout(() => {
        const formData = new FormData();
        formData.append('note', note);
        formData.append('amount', amount);
        formData.append('entry_type', type);
        
        fetch('/ai/suggest-category', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.suggestion) {
                showAISuggestion(data.suggestion);
            } else {
                dismissAISuggestion();
            }
        })
        .catch(error => {
            console.error('AI suggestion error:', error);
            dismissAISuggestion();
        });
    }, 500);
}

function showAISuggestion(suggestion) {
    currentSuggestion = suggestion;
    const suggestionDiv = document.getElementById('ai-suggestion');
    const suggestionText = document.getElementById('suggestion-text');
    const confidencePercentage = document.getElementById('confidence-percentage');
    const confidenceBar = document.getElementById('confidence-bar');

    const confidence = Math.round(suggestion.confidence_score * 100);

    // Update suggestion text
    suggestionText.innerHTML = `<strong style="font-size: 0.9rem;">${suggestion.category_name}</strong>`;

    // Update confidence percentage
    confidencePercentage.textContent = `${confidence}%`;

    // Update progress bar with color based on confidence level
    confidenceBar.style.width = `${confidence}%`;

    if (confidence >= 80) {
        confidenceBar.className = 'progress-bar bg-success';
        confidencePercentage.style.color = '#28a745';
    } else if (confidence >= 60) {
        confidenceBar.className = 'progress-bar bg-info';
        confidencePercentage.style.color = '#17a2b8';
    } else if (confidence >= 40) {
        confidenceBar.className = 'progress-bar bg-warning';
        confidencePercentage.style.color = '#ffc107';
    } else {
        confidenceBar.className = 'progress-bar bg-danger';
        confidencePercentage.style.color = '#dc3545';
    }

    // Show suggestion with animation
    suggestionDiv.style.display = 'block';
    suggestionDiv.style.opacity = '0';
    setTimeout(() => {
        suggestionDiv.style.transition = 'opacity 0.3s ease';
        suggestionDiv.style.opacity = '1';
    }, 10);
}

function acceptAISuggestion() {
    if (currentSuggestion) {
        // Set the category in the form
        const categorySelect = document.querySelector('select[name="category_id"]');
        categorySelect.value = currentSuggestion.category_id;

        // Add visual feedback
        categorySelect.style.borderColor = '#28a745';
        categorySelect.style.boxShadow = '0 0 0 0.2rem rgba(40, 167, 69, 0.25)';

        setTimeout(() => {
            categorySelect.style.borderColor = '';
            categorySelect.style.boxShadow = '';
        }, 2000);

        // Record positive feedback to AI system
        recordAIFeedback(currentSuggestion.suggestion_id, true);

        dismissAISuggestion();

        // Show success message
        showToast('AI suggestion applied! The AI will learn from your choice.', 'success');
    }
}

function rejectAISuggestion() {
    if (currentSuggestion) {
        // Record negative feedback to AI system
        recordAIFeedback(currentSuggestion.suggestion_id, false);

        dismissAISuggestion();

        // Show info message
        showToast('Suggestion dismissed. The AI will learn from this.', 'info');
    }
}

async function recordAIFeedback(suggestionId, accepted) {
    try {
        const formData = new FormData();
        formData.append('suggestion_id', suggestionId);
        formData.append('accepted', accepted);

        const response = await fetch('/ai/feedback', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            console.log('AI feedback recorded successfully');

            // Trigger auto-training if enough feedback accumulated
            checkAndTriggerAutoTraining();
        } else {
            console.error('Failed to record AI feedback:', data.message);
        }
    } catch (error) {
        console.error('Error recording AI feedback:', error);
    }
}

function dismissAISuggestion() {
    const suggestionDiv = document.getElementById('ai-suggestion');
    suggestionDiv.style.transition = 'opacity 0.3s ease';
    suggestionDiv.style.opacity = '0';

    setTimeout(() => {
        suggestionDiv.style.display = 'none';
        suggestionDiv.style.opacity = '1';
    }, 300);

    currentSuggestion = null;
}

async function checkAndTriggerAutoTraining() {
    try {
        // Get model status to check feedback count
        const response = await fetch('/ai/model/status');
        const data = await response.json();

        if (data.success && data.model) {
            const feedbackCount = data.model.feedback_count || 0;
            const lastTrainedAt = data.model.last_trained_at;

            // Auto-trigger training if:
            // 1. More than 50 feedback entries accumulated, OR
            // 2. More than 20 feedback entries and model hasn't been trained in 7 days
            const shouldTrain = feedbackCount >= 50 ||
                               (feedbackCount >= 20 && isModelStale(lastTrainedAt, 7));

            if (shouldTrain) {
                console.log(`Auto-training triggered: ${feedbackCount} feedback entries`);
                triggerModelTraining();
            }
        }
    } catch (error) {
        console.error('Error checking auto-training:', error);
    }
}

function isModelStale(lastTrainedAt, daysThreshold) {
    if (!lastTrainedAt) return true;

    const lastTrained = new Date(lastTrainedAt);
    const now = new Date();
    const daysSinceTraining = (now - lastTrained) / (1000 * 60 * 60 * 24);

    return daysSinceTraining > daysThreshold;
}

async function triggerModelTraining() {
    try {
        console.log('Starting background model training...');

        const response = await fetch('/ai/model/retrain', {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            console.log('Model training started successfully');
            showToast('AI model training started in background', 'info');
        } else {
            console.error('Failed to start model training:', data.message);
        }
    } catch (error) {
        console.error('Error triggering model training:', error);
    }
}

function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-robot me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    // Add to page
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    toastContainer.appendChild(toast);
    
    // Initialize and show toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove from DOM after hiding
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

// Load More functionality
let currentOffset = {{ offset }};
let currentLimit = {{ limit }};
let totalCount = {{ total_count }};
const sortBy = "{{ sort_by }}";
const sortOrder = "{{ order }}";
const startDate = "{{ start_date or '' }}";
const endDate = "{{ end_date or '' }}";
const selectedCategory = "{{ selected_category or '' }}";

async function loadMoreEntries() {
    const btn = document.getElementById('load-more-btn');
    const loading = document.getElementById('load-more-loading');
    const container = document.getElementById('load-more-container');
    const tbody = document.getElementById('entries-tbody');

    // Show loading state
    btn.style.display = 'none';
    loading.style.display = 'block';

    // Calculate new offset
    const newOffset = currentOffset + currentLimit;

    // Build URL with query parameters
    const params = new URLSearchParams();
    params.append('offset', newOffset);
    params.append('limit', currentLimit);
    params.append('sort_by', sortBy);
    params.append('order', sortOrder);
    if (startDate) params.append('start', startDate);
    if (endDate) params.append('end', endDate);
    if (selectedCategory) params.append('category', selectedCategory);

    try {
        const response = await fetch(`/entries/load-more?${params.toString()}`);
        if (!response.ok) throw new Error('Failed to load entries');

        const html = await response.text();

        // Append new rows to tbody
        tbody.insertAdjacentHTML('beforeend', html);

        // Update offset
        currentOffset = newOffset;

        // Update remaining count
        const showingTo = Math.min(currentOffset + currentLimit, totalCount);
        const remaining = totalCount - showingTo;

        if (remaining > 0) {
            // Still more entries, update count and show button
            document.getElementById('remaining-count').textContent = `${remaining} remaining`;
            btn.style.display = 'inline-block';
            loading.style.display = 'none';
        } else {
            // No more entries, hide the load more container
            container.style.display = 'none';
        }

        // Update the showing count in the header
        updateShowingCount(showingTo);

    } catch (error) {
        console.error('Error loading more entries:', error);
        showToast('Failed to load more entries', 'error');
        btn.style.display = 'inline-block';
        loading.style.display = 'none';
    }
}

async function loadMoreMobileEntries() {
    const btn = document.getElementById('load-more-mobile-btn');
    const loading = document.getElementById('load-more-mobile-loading');
    const container = document.getElementById('load-more-mobile-container');
    const listContainer = document.getElementById('mobile-entries-list');

    // Show loading state
    btn.style.display = 'none';
    loading.style.display = 'block';

    // Calculate new offset
    const newOffset = currentOffset + currentLimit;

    // Build URL with query parameters
    const params = new URLSearchParams();
    params.append('offset', newOffset);
    params.append('limit', currentLimit);
    params.append('sort_by', sortBy);
    params.append('order', sortOrder);
    if (startDate) params.append('start', startDate);
    if (endDate) params.append('end', endDate);
    if (selectedCategory) params.append('category', selectedCategory);

    try {
        const response = await fetch(`/entries/load-more-mobile?${params.toString()}`);
        if (!response.ok) throw new Error('Failed to load entries');

        const html = await response.text();

        // Append new cards to the list
        listContainer.insertAdjacentHTML('beforeend', html);

        // Update offset
        currentOffset = newOffset;

        // Update remaining count
        const showingTo = Math.min(currentOffset + currentLimit, totalCount);
        const remaining = totalCount - showingTo;

        if (remaining > 0) {
            // Still more entries, update count and show button
            document.getElementById('remaining-count-mobile').textContent = `${remaining} remaining`;
            btn.style.display = 'block';
            loading.style.display = 'none';
        } else {
            // No more entries, hide the load more container
            container.style.display = 'none';
        }

        // Update the showing count in the header
        updateShowingCount(showingTo);

    } catch (error) {
        console.error('Error loading more entries:', error);
        showToast('Failed to load more entries', 'error');
        btn.style.display = 'block';
        loading.style.display = 'none';
    }
}

function updateShowingCount(showingTo) {
    const tbody = document.getElementById('entries-tbody');
    const rows = tbody ? tbody.querySelectorAll('tr').length : 0;

    // If we've loaded all available entries (no load-more button), align totalCount to visible rows
    const loadMoreContainer = document.getElementById('load-more-container');
    const hasMoreVisible = loadMoreContainer && loadMoreContainer.style.display !== 'none';

    let showingFrom = rows > 0 ? 1 : 0;
    let effectiveShowingTo = showingTo;

    if (!hasMoreVisible) {
        // All entries are currently visible in the table
        totalCount = rows;
        effectiveShowingTo = rows;
    } else {
        // Clamp to totalCount in case of rounding
        effectiveShowingTo = Math.min(showingTo, totalCount);
    }

    const showingText = document.getElementById('entries-summary-text');
    if (showingText) {
        showingText.innerHTML = `<i class="bi bi-list-ul me-1"></i> Showing ${showingFrom} to ${effectiveShowingTo} of ${totalCount} entries`;
    }
}

// Recalculate counts after HTMX updates to the entries table (e.g., delete, create)
document.body.addEventListener('htmx:afterSwap', function (event) {
    if (event.detail && event.detail.target && event.detail.target.id === 'entries-tbody') {
        const tbody = document.getElementById('entries-tbody');
        const rows = tbody ? tbody.querySelectorAll('tr').length : 0;
        const showingTo = rows;
        updateShowingCount(showingTo);
    }
});

// Initialize AI suggestions when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Check if AI features are enabled
    fetch('/ai/insights')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('AI features are available');
            }
        })
        .catch(error => {
            console.log('AI features not available');
        });
    
    // Date filter enhancements
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    // Set default date range to current month if no dates are set
    if (!startDateInput.value && !endDateInput.value) {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        
        startDateInput.value = firstDay.toISOString().split('T')[0];
        endDateInput.value = lastDay.toISOString().split('T')[0];
    }
    
    // Validate date range
    function validateDateRange() {
        const startDate = new Date(startDateInput.value);
        const endDate = new Date(endDateInput.value);
        
        if (startDate && endDate && startDate > endDate) {
            endDateInput.setCustomValidity('End date must be after start date');
            endDateInput.reportValidity();
        } else {
            endDateInput.setCustomValidity('');
        }
    }
    
    startDateInput.addEventListener('change', validateDateRange);
    endDateInput.addEventListener('change', validateDateRange);
    
    // Quick date range buttons
    addQuickDateButtons();
});

function addQuickDateButtons() {
    const dateFilterCard = document.querySelector('.card .card-body');
    if (!dateFilterCard) return;
    
    const quickButtonsContainer = document.createElement('div');
    quickButtonsContainer.className = 'mt-3';
    quickButtonsContainer.innerHTML = `
        <div class="d-flex flex-wrap gap-2">
            <small class="text-light me-2" style="opacity: 0.8;">Quick filters:</small>
            <button type="button" class="btn btn-sm btn-outline-info" onclick="setDateRange('today')">Today</button>
            <button type="button" class="btn btn-sm btn-outline-info" onclick="setDateRange('week')">This Week</button>
            <button type="button" class="btn btn-sm btn-outline-info" onclick="setDateRange('month')">This Month</button>
            <button type="button" class="btn btn-sm btn-outline-info" onclick="setDateRange('year')">This Year</button>
        </div>
    `;
    
    dateFilterCard.appendChild(quickButtonsContainer);
}

function setDateRange(range) {
    const today = new Date();
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    let startDate, endDate;
    
    switch(range) {
        case 'today':
            startDate = endDate = today;
            break;
        case 'week':
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());
            startDate = startOfWeek;
            endDate = today;
            break;
        case 'month':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            break;
        case 'year':
            startDate = new Date(today.getFullYear(), 0, 1);
            endDate = new Date(today.getFullYear(), 11, 31);
            break;
    }
    
    startDateInput.value = startDate.toISOString().split('T')[0];
    endDateInput.value = endDate.toISOString().split('T')[0];
    
    // Auto-submit the form
    document.querySelector('form[method="GET"]').submit();
}

// Export functions
function getCurrentFilters() {
    const start = document.getElementById('start_date').value;
    const end = document.getElementById('end_date').value;
    const category = document.getElementById('category_filter').value;
    
    const params = new URLSearchParams();
    if (start) params.append('start', start);
    if (end) params.append('end', end);
    if (category) params.append('category', category);
    
    return params.toString();
}

function exportToExcel() {
    const filters = getCurrentFilters();
    const url = `/reports/excel/entries?${filters}`;
    window.open(url, '_blank');
}

function exportToPDF() {
    const filters = getCurrentFilters();
    const url = `/reports/pdf/financial?${filters}`;
    window.open(url, '_blank');
}

// Mobile layout synchronization - simple approach
function refreshMobileLayout() {
    // Simply reload the page to sync both desktop and mobile layouts
    // This is a simple solution that works reliably
    setTimeout(() => {
        location.reload();
    }, 500);
}

// Listen for HTMX events to refresh mobile layout
document.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.target.id === 'entries-tbody') {
        refreshMobileLayout();
    }
});
</script>

<style>
/* Mobile Card Layout Styles */
.mobile-entry-card {
  background: var(--panel);
  border: 1px solid #1c2440;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  transition: all 0.2s ease;
}

.mobile-entry-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

.type-badge-mobile {
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.type-badge-mobile.income {
  background: linear-gradient(135deg, #28a745, #20c997);
  color: white;
}

.type-badge-mobile.expense {
  background: linear-gradient(135deg, #dc3545, #fd7e14);
  color: white;
}

.entry-amount {
  font-size: 1.1rem;
  font-weight: 700;
}

.entry-amount.income-amount {
  color: #28a745;
}

.entry-amount.expense-amount {
  color: #dc3545;
}

.entry-category .badge {
  font-size: 0.75rem;
  padding: 0.375rem 0.75rem;
}

.entry-note {
  background: rgba(255, 255, 255, 0.05);
  padding: 0.5rem;
  border-radius: 6px;
  border-left: 3px solid #667eea;
}

/* Mobile Responsive Design for Entries Page */
@media (max-width: 768px) {
  /* Make form inputs stack vertically on mobile */
  .row.g-3 .col-md-3 {
    margin-bottom: 1rem;
  }
  
  /* Improve button spacing on mobile */
  .d-flex.gap-2.flex-wrap {
    justify-content: center;
    gap: 0.75rem !important;
  }
  
  .d-flex.gap-2.flex-wrap .btn {
    padding: 12px 16px;
    min-height: 48px;
    font-size: 0.9rem;
    flex: 1;
    min-width: 120px;
  }
  
  /* Export buttons - make them full width on mobile */
  .col-12 .d-flex.gap-2.flex-wrap {
    flex-direction: column;
    gap: 0.75rem !important;
  }
  
  .col-12 .d-flex.gap-2.flex-wrap .btn {
    width: 100%;
    padding: 14px 16px;
    min-height: 52px;
    font-size: 1rem;
  }
  
  /* Mobile card layout improvements */
  .mobile-entry-card .card-body {
    padding: 1rem;
  }
  
  .mobile-entry-card .btn-sm {
    padding: 10px 16px;
    min-height: 48px;
    font-size: 0.9rem;
    font-weight: 600;
  }
  
  .mobile-entry-card .flex-fill {
    flex: 1;
  }
  
  /* Improve form styling for mobile */
  .form-control {
    padding: 12px;
    font-size: 16px; /* Prevents zoom on iOS */
  }
  
  .form-select {
    padding: 12px;
    font-size: 16px; /* Prevents zoom on iOS */
  }
  
  /* Card spacing adjustments */
  .card {
    margin-bottom: 1rem;
  }
  
  .card-body {
    padding: 1rem;
  }
  
  /* Header adjustments */
  .d-flex.justify-content-between.align-items-center {
    flex-direction: column;
    align-items: stretch;
    gap: 1rem;
  }
  
  .d-flex.gap-2 {
    justify-content: center;
  }
}

@media (max-width: 480px) {
  /* Extra small screens */
  .d-flex.gap-2.flex-wrap .btn {
    padding: 16px;
    min-height: 56px;
    font-size: 1rem;
  }
  
  .col-12 .d-flex.gap-2.flex-wrap .btn {
    padding: 16px;
    min-height: 56px;
    font-size: 1rem;
  }
  
  .table th,
  .table td {
    padding: 0.5rem 0.25rem;
    font-size: 0.8rem;
  }
  
  .btn-sm {
    padding: 6px 10px;
    min-height: 40px;
    font-size: 0.8rem;
  }
  
  .form-control,
  .form-select {
    padding: 14px;
    font-size: 16px;
  }
}
</style>

<!-- Bulk AI Categorization Modal -->
<div class="modal fade" id="bulkAIModal" tabindex="-1" aria-labelledby="bulkAIModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" style="background: linear-gradient(135deg, #1a1f36 0%, #0f1419 100%); border: 1px solid rgba(77, 163, 255, 0.3);">
      <div class="modal-header" style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
        <h5 class="modal-title" id="bulkAIModalLabel">
          <i class="bi bi-robot me-2" style="color: #4da3ff;"></i>
          Bulk AI Categorization
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info" style="background: rgba(77, 163, 255, 0.1); border: 1px solid rgba(77, 163, 255, 0.3);">
          <i class="bi bi-info-circle me-2"></i>
          <strong>How it works:</strong> The AI will analyze all uncategorized entries and suggest categories based on transaction descriptions, amounts, and patterns.
        </div>

        <!-- Options -->
        <div class="mb-4">
          <label class="form-label fw-bold">
            <i class="bi bi-sliders me-2"></i>
            Categorization Options
          </label>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="autoApply" checked>
            <label class="form-check-label" for="autoApply">
              Automatically apply high-confidence suggestions (â‰¥80%)
            </label>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="onlyUncategorized" checked>
            <label class="form-check-label" for="onlyUncategorized">
              Only process uncategorized entries
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="recordFeedback" checked>
            <label class="form-check-label" for="recordFeedback">
              Record as training feedback for AI improvement
            </label>
          </div>
        </div>

        <!-- Progress Section -->
        <div id="bulkAIProgress" style="display: none;">
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-light">Processing entries...</span>
              <span id="bulkProgressText" class="fw-bold text-info">0 / 0</span>
            </div>
            <div class="progress" style="height: 8px; background: rgba(0,0,0,0.3);">
              <div id="bulkProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width: 0%"></div>
            </div>
          </div>
          <div id="bulkResults" class="mt-3" style="max-height: 300px; overflow-y: auto;"></div>
        </div>

        <!-- Summary Section -->
        <div id="bulkAISummary" style="display: none;">
          <div class="alert alert-success" style="background: rgba(40, 167, 69, 0.1); border: 1px solid rgba(40, 167, 69, 0.3);">
            <h6 class="alert-heading">
              <i class="bi bi-check-circle me-2"></i>
              Categorization Complete!
            </h6>
            <div class="mt-2">
              <p class="mb-1"><strong>Total Processed:</strong> <span id="summaryTotal">0</span> entries</p>
              <p class="mb-1"><strong>Auto-Applied:</strong> <span id="summaryApplied">0</span> (high confidence)</p>
              <p class="mb-1"><strong>Requires Review:</strong> <span id="summaryPending">0</span> (low confidence)</p>
              <p class="mb-0"><strong>Average Confidence:</strong> <span id="summaryAvgConfidence">0%</span></p>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="border-top: 1px solid rgba(255, 255, 255, 0.1);">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="startBulkAI" onclick="startBulkAICategorization()">
          <i class="bi bi-play-circle me-1"></i>
          Start Categorization
        </button>
        <button type="button" class="btn btn-success" id="reloadAfterBulk" style="display: none;" onclick="location.reload()">
          <i class="bi bi-arrow-clockwise me-1"></i>
          Reload Page
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Bulk AI Categorization Functions
let bulkAIModal = null;

function openBulkAIModal() {
    if (!bulkAIModal) {
        bulkAIModal = new bootstrap.Modal(document.getElementById('bulkAIModal'));
    }

    // Reset modal state
    document.getElementById('bulkAIProgress').style.display = 'none';
    document.getElementById('bulkAISummary').style.display = 'none';
    document.getElementById('startBulkAI').style.display = 'block';
    document.getElementById('reloadAfterBulk').style.display = 'none';
    document.getElementById('bulkResults').innerHTML = '';

    bulkAIModal.show();
}

async function startBulkAICategorization() {
    const autoApply = document.getElementById('autoApply').checked;
    const onlyUncategorized = document.getElementById('onlyUncategorized').checked;
    const recordFeedback = document.getElementById('recordFeedback').checked;

    // Hide start button, show progress
    document.getElementById('startBulkAI').style.display = 'none';
    document.getElementById('bulkAIProgress').style.display = 'block';

    try {
        // Fetch uncategorized entries
        const response = await fetch('/entries/uncategorized');
        const data = await response.json();

        if (!data.success || !data.entries || data.entries.length === 0) {
            document.getElementById('bulkAIProgress').style.display = 'none';
            document.getElementById('bulkAISummary').style.display = 'block';

            document.getElementById('bulkAISummary').innerHTML = `
                <div class="alert alert-info" style="background: rgba(77, 163, 255, 0.1); border: 1px solid rgba(77, 163, 255, 0.3);">
                    <h6 class="alert-heading">
                        <i class="bi bi-info-circle me-2"></i>
                        No Uncategorized Entries
                    </h6>
                    <p class="mb-0">Great! You don't have any uncategorized entries. All your transactions are already organized.</p>
                </div>
            `;

            document.getElementById('reloadAfterBulk').style.display = 'none';
            document.getElementById('startBulkAI').style.display = 'block';

            showToast('No uncategorized entries found', 'info');
            return;
        }

        const entries = data.entries;
        const total = entries.length;
        let processed = 0;
        let applied = 0;
        let pending = 0;
        let totalConfidence = 0;

        const resultsDiv = document.getElementById('bulkResults');
        const progressBar = document.getElementById('bulkProgressBar');
        const progressText = document.getElementById('bulkProgressText');

        progressText.textContent = `0 / ${total}`;

        // Process entries one by one
        for (const entry of entries) {
            try {
                // Get AI suggestion
                const formData = new FormData();
                formData.append('note', entry.note || '');
                formData.append('description', entry.description || '');
                formData.append('amount', entry.amount);
                formData.append('entry_type', entry.type);

                const suggestionResponse = await fetch('/ai/suggest-category', {
                    method: 'POST',
                    body: formData
                });

                const suggestionData = await suggestionResponse.json();

                if (suggestionData.success && suggestionData.suggestion) {
                    const suggestion = suggestionData.suggestion;
                    const confidence = Math.round(suggestion.confidence_score * 100);
                    totalConfidence += confidence;

                    // Auto-apply if confidence is high enough
                    if (autoApply && confidence >= 80) {
                        // Update entry category
                        const updateResponse = await fetch(`/entries/${entry.id}/category`, {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({category_id: suggestion.category_id})
                        });

                        if (updateResponse.ok) {
                            applied++;
                            addResultRow(resultsDiv, entry, suggestion.category_name, confidence, 'applied');

                            // Record feedback if enabled
                            if (recordFeedback) {
                                recordAIFeedback(suggestion.suggestion_id, true);
                            }
                        }
                    } else {
                        pending++;
                        addResultRow(resultsDiv, entry, suggestion.category_name, confidence, 'pending');
                    }
                } else {
                    addResultRow(resultsDiv, entry, 'N/A', 0, 'failed');
                }
            } catch (error) {
                console.error('Error processing entry:', entry.id, error);
                addResultRow(resultsDiv, entry, 'Error', 0, 'failed');
            }

            // Update progress
            processed++;
            const progress = (processed / total) * 100;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${processed} / ${total}`;

            // Small delay to prevent overwhelming the server
            await new Promise(resolve => setTimeout(resolve, 200));
        }

        // Show summary
        document.getElementById('bulkAIProgress').style.display = 'none';
        document.getElementById('bulkAISummary').style.display = 'block';
        document.getElementById('reloadAfterBulk').style.display = 'block';

        document.getElementById('summaryTotal').textContent = total;
        document.getElementById('summaryApplied').textContent = applied;
        document.getElementById('summaryPending').textContent = pending;
        document.getElementById('summaryAvgConfidence').textContent =
            total > 0 ? Math.round(totalConfidence / total) + '%' : '0%';

        showToast(`Bulk categorization complete! ${applied} entries categorized.`, 'success');

    } catch (error) {
        console.error('Bulk AI categorization error:', error);
        showToast('Failed to perform bulk categorization', 'error');
        document.getElementById('bulkAIProgress').style.display = 'none';
        document.getElementById('startBulkAI').style.display = 'block';
    }
}

function addResultRow(container, entry, category, confidence, status) {
    const statusColors = {
        applied: {bg: 'rgba(40, 167, 69, 0.1)', border: 'rgba(40, 167, 69, 0.3)', icon: 'check-circle', color: '#28a745'},
        pending: {bg: 'rgba(255, 193, 7, 0.1)', border: 'rgba(255, 193, 7, 0.3)', icon: 'clock', color: '#ffc107'},
        failed: {bg: 'rgba(220, 53, 69, 0.1)', border: 'rgba(220, 53, 69, 0.3)', icon: 'x-circle', color: '#dc3545'}
    };

    const style = statusColors[status] || statusColors.failed;

    const row = document.createElement('div');
    row.className = 'p-2 mb-2 rounded';
    row.style.background = style.bg;
    row.style.border = `1px solid ${style.border}`;
    row.style.fontSize = '0.85rem';

    row.innerHTML = `
        <div class="d-flex align-items-center justify-content-between">
            <div class="flex-grow-1">
                <i class="bi bi-${style.icon} me-2" style="color: ${style.color};"></i>
                <strong>${entry.note || entry.description || 'Unnamed entry'}</strong>
                <span class="text-muted ms-2">(${entry.amount} ${entry.currency_code || 'TRY'})</span>
            </div>
            <div class="text-end">
                <span class="badge" style="background: ${style.color};">${category}</span>
                ${confidence > 0 ? `<span class="ms-2 text-muted">${confidence}%</span>` : ''}
            </div>
        </div>
    `;

    container.appendChild(row);

    // Auto-scroll to bottom
    container.scrollTop = container.scrollHeight;
}
</script>

{% endblock %}